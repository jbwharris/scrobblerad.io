!function(){const t="img/defaultArt.png";let e=Object.keys(stations),a="all";function i(t="all"){a=t;const i=document.getElementById("stationSelect");i.innerHTML="";const s=document.createDocumentFragment();let r;"all"===t?r=e.filter((t=>!!stations[t])):(r=e.filter((e=>{const a=stations[e];return!!a&&a.tags&&a.tags.includes(t)})),0===r.length&&(r=e.filter((t=>!!stations[t])))),r.forEach((t=>{const e=stations[t];if(!e)return;const a=document.createElement("button");a.name=t,a.textContent=e.stationName;const i=document.createElement("input");i.type="radio",i.name="station",i.value=t,i.checked=t===n.stationName;const r=document.createElement("img");r.src=`img/stations/${t}.png`,r.width="45",r.height="45",r.loading="lazy",a.appendChild(i),a.prepend(r),s.appendChild(a)})),i.appendChild(s),document.getElementById("togglePanels").addEventListener("click",(function(){const t=document.getElementById("panel1"),e=document.getElementById("panel2"),a=document.getElementById("panel3"),i=document.querySelector("#togglePanels .icon-hide-panels, #togglePanels .icon-show-panels");t.classList.toggle("show"),e.classList.toggle("grow"),a.classList.toggle("show"),i&&(i.classList.contains("icon-hide-panels")?(i.classList.remove("icon-hide-panels"),i.classList.add("icon-show-panels")):(i.classList.remove("icon-show-panels"),i.classList.add("icon-hide-panels")))}))}class s{constructor(t,e){this.stationName=t,this.radioPlayer=e,this.displayStationName=this.radioPlayer.currentStationData[this.stationName].stationName,this.scrobbleTimeout=null,this.cacheDOMElements(),this.template=document.querySelector("#meta")}cacheDOMElements(){const t={currentSong:"title",currentArtist:"artist",currentAlbum:"album",currentListeners:"listeners",coverArt:"albumArt",radioNameLink:"radioNameLink",radioName:"radioName",stationLocation:"stationLocation",metaInfo:"metainfo"};for(const[e,a]of Object.entries(t))this[e+"Element"]=document.getElementById(a)}formatCompactNumber(t){return t<1e3?t:t>=1e3&&t<1e6?(t/1e3).toFixed(1).replace(/\.0$/,"")+"K":t>=1e6&&t<1e9?(t/1e6).toFixed(1).replace(/\.0$/,"")+"M":t>=1e9&&t<1e12?(t/1e9).toFixed(1).replace(/\.0$/,"")+"B":void 0}refreshCurrentData(t){const[e,a,i,s,n,r,o]=t;this.scrobbleTimeout&&(clearTimeout(this.scrobbleTimeout),this.scrobbleTimeout=null);const l=this.radioPlayer.currentStationData[this.stationName];if(!e&&!a||!l)return;document.getElementById("playermeta").classList.toggle("errorMessage",Boolean(o));const c=document.querySelector("div.playermeta");c.textContent="";const h=document.querySelector("#meta"),d=document.importNode(h.content,!0);d.querySelector("#title").innerHTML=e,d.querySelector("#artist").textContent=a,d.querySelector("#album").textContent=i;const u=null!==n&&null!==r?`Listeners: ${this.formatCompactNumber(n)} | Plays: ${this.formatCompactNumber(r)}`:"";d.querySelector("#listeners").textContent=u;const m=d.querySelector("#albumArt");this.radioPlayer.validateArtworkUrl(s).then((t=>{if(t){const t=/^https?:\/\//i.test(s)?s:`../${s}`;this.artworkUrl=s,m.src=s,m.alt=`${e} by ${a}`,document.documentElement.style.setProperty("--albumArt",`url("${t}")`)}else this.artworkUrl||(this.artworkUrl=this.stationArt,m.src="",m.alt="",document.documentElement.style.setProperty("--albumArt",`url("${this.stationArt}")`))})),d.querySelector("#radioNameLink").href=l.webUrl,d.querySelector("#radioName").textContent=l.stationName,d.querySelector("#stationLocation").textContent=l.location,c.appendChild(d),document.getElementById("playermeta").classList.remove("opacity-50"),function(t,e=2e3){t.classList.add("animated","fadeIn"),setTimeout((()=>{t.classList.remove("animated","fadeIn")}),e)}(c),document.querySelector("#panel2").click(),this.setupMediaSession(e,a,s,o)}setupMediaSession(e,a,i,s){if(e.includes("<br/>"))return;let n="";s||"currently loading"===a?n="":e&&a&&"currently loading"!==a&&(n=`Now playing on ${this.displayStationName}`);let r=`../img/stations/${this.stationName}.png`;if(!i||i===t&&i===r||(r=i),"mediaSession"in navigator){if(navigator.mediaSession.metadata=new MediaMetadata({title:e,artist:a||"",album:n||"",duration:1/0,startTime:0,artwork:[{src:r}]}),!e&&!a||"currently loading"===a)return void(document.title="");(e&&a||!s)&&(document.title=`${e} - ${a} | ${this.displayStationName} on scrobblerad.io`);const t={nexttrack:()=>this.radioPlayer.skipForward(),previoustrack:()=>this.radioPlayer.skipBackward(),play:()=>this.radioPlayer.togglePlay(),pause:()=>this.radioPlayer.togglePlay()};for(const[e,a]of Object.entries(t))navigator.mediaSession.setActionHandler(e,a)}}}document.getElementById("stationSelect").addEventListener("click",(function(t){const e=t.target.closest("button");if(e){const t=e.name;window.location.hash=`#${t}`,n.handleStationSelect(null,t,!0)}}));const n=new class{constructor(t,e,a,i){this.audio=new Audio,this.hls=null,this.isPlaying=null,this.shouldReloadStream=!1,this.pauseTimeout=null,this.duration=null,this.stationName="",this.currentStationData=null,this.previousDataResponse=null,this.prevExtractedData=null,this.stationArt="",this.songMetadataChanged=!1,this.lastDataUpdateTime=null,this.lastKnownUpdatedTime=null,this.errorMessage=!1,this.mytunerWidgetRemoved=!1,this.playButton=t,this.skipForwardButton=e,this.skipBackButton=a,this.reloadStreamButton=i,this.firstRun=!0,this.debounceTimeout=null,this.songStartTime=null,this.scrobbleTimeout=null,this.currentTrack=null,this.currentPage=null,this.streamingInterval=null,this.debouncedPlayAudio=this.debounce((t=>{this.audio&&(this.audio.pause(),this.audio=null),this.audio=t,this.getStreamingData(),this.play(),this.isPlaying=!0}),1500),this.bindMethods(),this.addEventListeners(),this.init()}setPage(t){this.page=t}bindMethods(){this.handleStationSelect=this.handleStationSelect.bind(this),this.getLfmMeta=this.getLfmMeta.bind(this),this.getStreamingData=this.getStreamingData.bind(this),this.extractSongAndArtist=this.extractSongAndArtist.bind(this),this.getPath=this.getPath.bind(this),this.upsizeImgUrl=this.upsizeImgUrl.bind(this),this.togglePlay=this.togglePlay.bind(this),this.skipForward=this.skipForward.bind(this),this.skipBackward=this.skipBackward.bind(this),this.reloadStream=this.reloadStream.bind(this)}async addEventListeners(){this.playButton.addEventListener("click",this.togglePlay),this.skipForwardButton.addEventListener("click",this.skipForward),this.skipBackButton.addEventListener("click",this.skipBackward),this.reloadStreamButton.addEventListener("click",this.reloadStream),document.getElementById("stationSelect").addEventListener("click",(t=>{t.target&&t.target.matches("input[name='station']")&&(this.handleStationSelect(t,t.target.value,!0),t.target.scrollIntoView({behavior:"smooth",block:"nearest"}))})),this.jumpToStationFromHash(),document.addEventListener("DOMContentLoaded",(()=>{this.jumpToStationFromHash()}),{once:!0})}init(){"serviceWorker"in navigator&&navigator.serviceWorker.register("serviceWorker.js").then((t=>{t.waiting&&console.log("Service worker is waiting to activate"),t.onupdatefound=()=>{console.log("New service worker update found!");const e=t.installing;e.onstatechange=()=>{"installed"===e.state&&(navigator.serviceWorker.controller?console.log("New service worker installed, but waiting to activate"):console.log("Service worker installed for the first time"))}}})).catch((t=>console.log("Service worker not registered",t)))}calculateNextAndPreviousIndices(t){let i;"all"===a?i=e.filter((t=>!!stations[t])):(i=e.filter((t=>{const e=stations[t];return!!e&&e.tags&&e.tags.includes(a)})),0===i.length&&(i=e.filter((t=>!!stations[t]))));const s=i.indexOf(this.stationName);-1!==s?"next"===t?(this.nextIndex=(s+1)%i.length,this.nextStationName=i[this.nextIndex]):"previous"===t&&(this.previousIndex=(s-1+i.length)%i.length,this.previousStationName=i[this.previousIndex]):console.error(`Current station "${this.stationName}" not found in filtered list.`)}debounce(t,e){return(...a)=>{this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=setTimeout((()=>{t.apply(this,a)}),e)}}jumpToStationFromHash(){const t=window.location.hash;if(t){const e=t.substring(1),a=document.querySelector(`button[name='${e}']`);a&&(a.scrollIntoView({behavior:"smooth",block:"center"}),this.handleStationSelect(null,e,!0))}}async loadStationData(t){try{const e=await fetch(t),a=await e.text();return new Function(a+"; return stationData;")()}catch(t){console.error("Error loading station data:",t)}}destroyHLSAndResetAudio(){this.hls&&(this.hls.destroy(),this.hls=null),this.audio&&(this.audio.removeAttribute("src"),this.audio.load())}async handleStationSelect(t,e,a){if(!e||!1===t)return;if(this.page&&this.page.scrobbleTimeout&&(clearTimeout(this.page.scrobbleTimeout),console.log("Scrobble timeout cleared due to station switch."),this.page.scrobbleTimeout=null),this.shouldReloadStream)return console.log("getting here on reload?"),document.getElementById("playermeta").classList.remove("opacity-50"),this.audio.load(),this.hls&&this.destroyHLSAndResetAudio(),void(this.shouldReloadStream=!1);this.currentPage&&(this.currentPage.destroy(),this.currentPage=null),document.getElementById("playermeta").classList.add("opacity-50");const i=await this.loadStationData(`/js/stations/${e}.js`);if(!i)return;this.currentStationData=i;const n=new s(e,this);this.streamingInterval&&(clearInterval(this.streamingInterval),this.streamingInterval=null),a&&!this.shouldReloadStream&&(this.stationName=e,this.stationArt=`../img/stations/${this.stationName}.png`,document.documentElement.style.setProperty("--albumArt",`url("../${this.stationArt}")`),document.documentElement.style.setProperty("--stationArt",`url("../${this.stationArt}")`),n.setupMediaSession(this.currentStationData[e].stationName,"currently loading",this.stationArt,!1),n.refreshCurrentData(["Station data loading","","",this.stationArt,null,null,!0]),this.playButton.lastElementChild.className="spinner-grow text-light",this.lfmMetaChanged=!1,console.log(e),this.updateArt=!0,this.isPlaying=!0,this.songMetadataChanged=!1,this.lastKnownUpdatedTime=null,a=!1);this.debounce((()=>{if(!this.isPlaying)return;if(!this.currentStationData[this.stationName])return void console.error("currentStationData is undefined or null");this.hls&&this.destroyHLSAndResetAudio();const a=new Audio;a.crossOrigin="anonymous";const i=this.currentStationData[this.stationName].streamUrl;if(i.endsWith(".m3u8")?this.hlsStreamLoad(i,a):(this.currentStationData[this.stationName].proxyStream?a.src=this.addCacheBuster(`https://scrobblerad.io/proxy.php?url=${this.currentStationData[this.stationName].streamUrl}`):a.src=this.addCacheBuster(i),a.load()),this.currentStationData[this.stationName].quietStream){const t=new(window.AudioContext||window.webkitAudioContext),e=t.createMediaElementSource(a),i=t.createGain();if(i.gain.value=this.currentStationData[this.stationName].gainBoost||2,console.log("station audio boosted"),e.connect(i),i.connect(t.destination),"suspended"===t.state){const e=()=>{t.resume(),window.removeEventListener("click",e)};window.addEventListener("click",e)}this.audioContext=t,this.audioGainNode=i}a.onloadedmetadata=()=>{this.lfmMetaChanged=!1,this.debouncedPlayAudio(a),this.streamingInterval=setInterval((()=>{this.getStreamingData()}),25e3)},a.onerror=e=>{console.warn("Error loading audio:",e),this.isPlaying&&(!0===t?this.skipBackward():this.skipForward())},a.load();const s=document.querySelector(`input[name='station'][value='${e}']`);s&&(s.checked=!0),window.location.hash=`#${e}`}),250)()}hlsStreamLoad(t,e){if(e.canPlayType("application/vnd.apple.mpegurl"))e.src=t,e.play().catch((t=>{console.error("Failed to play HLS natively:",t)}));else if(Hls.isSupported()){const a=new Hls;a.loadSource(t),a.attachMedia(e),a.on(Hls.Events.MANIFEST_PARSED,(()=>{e.play().catch((t=>{console.error("Failed to play HLS via HLS.js:",t)}))})),a.on(Hls.Events.ERROR,((t,e)=>{if(e.fatal)switch(e.type){case Hls.ErrorTypes.NETWORK_ERROR:console.error("Fatal network error encountered, try to recover"),a.startLoad();break;case Hls.ErrorTypes.MEDIA_ERROR:console.error("Fatal media error encountered, try to recover"),a.recoverMediaError();break;default:a.destroy(),console.error("Unrecoverable error, destroy HLS instance")}})),this.hls=a}else console.error("HLS is not supported in this browser and cannot be played.")}cleanupArtist(t){let e=t;if([/ x .*/,/ feat\..*/].forEach((t=>{e=e.replace(t,"")})),e.includes(", ")){const t=e.split(", ").map((t=>t.trim()));2===t.length?e=`${t[1]} ${t[0]}`:t.length>2&&(e=`${t.slice(-1)[0]} ${t.slice(0,-1).join(" ")}`)}return e.trim()}getFilterSet(){return{artist:[MetadataFilter.normalizeFeature],track:[MetadataFilter.removeRemastered,MetadataFilter.removeFeature,MetadataFilter.removeLive,MetadataFilter.removeCleanExplicit,MetadataFilter.removeVersion,MetadataFilter.youtube],album:[MetadataFilter.removeRemastered,MetadataFilter.removeFeature,MetadataFilter.removeLive,MetadataFilter.removeCleanExplicit,MetadataFilter.removeVersion]}}applyFilters(t,e){return["track","artist","album"].includes(t)||console.error(`Invalid filter field: ${t}`),e}getDataAtPath(t,e){const a=t.split(".");let i=e;for(let t of a){if(!i||!i.hasOwnProperty(t))return;i=i[t]}return i}getLastJsonPath(t,e){if("string"!=typeof t||!t)return console.error("Invalid path passed to getLastJsonPath:",t),t;const a=t.split(".");for(let t=0;t<a.length;t++)if(/^\d+$/.test(a[t])){const i=a.slice(0,t).join("."),s=this.getDataAtPath(i,e);Array.isArray(s)&&(a[t]=(s.length-1).toString());break}return a.join(".")}extractSongAndArtist(e,a){const i=t=>t?.replace(/&apos;|&#039;|‚Äô|‚Äò|‚Äö|‚Äõ|`|¬¥/g,"'").replace(/‚Äì|‚Äî/g,"-").replace(/[‚Äú‚Äù‚Äû]/g,'"').replace(/‚Ä¶/g,"...").replace(/\u00A0/g," ").replace(/[\t\n\r]/g,"").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/\s*\[.*?\]/g,"").replace(/[*/|\\]/g,"").replace(/--/g,"-").replace(/\s*\(Current Track\)\s*/gi,"").replace(/\b(tUnE yArDs|tune-yards|tuneyards)\b/gi,"tUnE-yArDs").replace(/\b(Lets|Its|Ive|Dont|Cant|Wont|Aint)\b/gi,(t=>({Lets:"Let's",Its:"It's",Ive:"I've",Dont:"Don't",Cant:"Can't",Wont:"Won't",Aint:"Ain't",Youve:"You've"}[t]||t))).replace(/\b(Somethin|Nothin)\b/gi,(t=>({Somethin:"Somethin'",Nothin:"Nothin'"}[t]||t))).trim()||"",s=t=>t?t.replace(/\s*\(.*?version.*?\)/gi,"").replace(/\s-\s.*version.*$/i,"").replace(/\s-\s.*kqua.*$/i,"").replace(/\s-\s.*mix.*$/i,"").replace(/\s*-\s*\([^\)]*\)/g,"").replace(/\s*\(.*?edit.*?\)/gi,"").replace(/\s*\(.*?Feat\..*?\)|\s+Feat\..*?/gi,"").replace(/\s*\(.*?clean.*?\)/gi,"").replace(/\s-\s.*edit.*$/i,"").replace(/[\(\[]\d{4}\s*Mix[\)\]]/gi,"").replace(/\s*\(\d{4}\s*-\s*Remaster(ed)?\)/gi,"").replace(/\s*\([\d]{4}\s*Remaster(ed)?\)/gi,"").replace(/\s*-\s*[\d]{4}\s*Remaster(ed)?/gi,"").replace(/\s*-\s*Remaster(ed)?/gi,"").replace(/([\)\]])\s*\d{4}.*/,"").replace(/\s*[\(\[].*?\b\d{4}\b.*?[\)\]]\s*/g,"").replace(/\s*\(.*?\bofficial\b.*?\)/gi,"").replace(/\s*\(.*?\bsingle\b.*?\)/gi,"").replace(/\s*\(.*?\bsession\b.*?\)/gi,"").replace(/\s*\(.*?\bcover\b.*?\)/gi,"").replace(/\s-\s.*single.*$/i,"").trim():"",n=t=>this.getPath(e,this.currentStationData[this.stationName][t]),r=this.currentStationData[this.stationName].pathRegex||/^(.*?)\s+-\s+(.*?)(?:\s+-\s+([^-\n]*))?(?:\s+-\s+(.*))?$/,o=this.currentStationData[this.stationName].pathRegex2,l=r.exec(e);let c=s(n("song")),h=this.applyFilters("artist",n("artist")),d=this.applyFilters("album",n("album")),u=n("albumArt"),m="",p=e.title;if(this.currentStationData[a].reverseArray&&(c=s(this.getPath(e,this.getLastJsonPath(this.currentStationData[a].song,e))),h=this.applyFilters("artist",this.getPath(e,this.getLastJsonPath(this.currentStationData[a].artist,e))),d=this.applyFilters("album",this.getPath(e,this.getLastJsonPath(this.currentStationData[a].album,e))),console.log("song, artist and album reverse array",c,h,d)),this.currentStationData[this.stationName].altPath&&!c&&(c=s(n("song2")),h=this.applyFilters("artist",n("artist2")),d=this.applyFilters("album",n("album2")),u=n("albumArt2")),this.currentStationData[this.stationName].spinPath&&(c=s(e.song)||"",h=this.applyFilters("artist",e.artist)||"",d=this.applyFilters("album",e.album)||"",u=e.albumArt||"",m=e.spinUpdated||"",console.log("spinUpdated being assigned here",m)),this.currentStationData[this.stationName].htmlString&&(c=s(e.song)||"",h=this.applyFilters("artist",e.artist)||"",d=this.applyFilters("album",e.album)||"",u=e.albumArt||"",m=e.spinUpdated||"",console.log("spinUpdated being assigned here",m)),this.currentStationData[this.stationName].orbPath||this.currentStationData[this.stationName].dataPath){1==this.currentStationData[this.stationName].dataPath?p=e.data.title:this.currentStationData[this.stationName].dataPath&&(p=e[this.currentStationData[this.stationName].dataPath]);const t=r.exec(p);if(t)[h,c,d]=t.slice(1,4).map((t=>t?.trim())),c=s(c),h=this.applyFilters("artist",h),d=this.applyFilters("album",d),this.currentStationData[this.stationName].flipMeta&&([c,h]=[h,c]);else if(!t&&o){const t=o.exec(p);[h,c,d]=t.slice(1,4).map((t=>t?.trim())),c=s(c),h=this.applyFilters("artist",h),d=this.applyFilters("album",d),this.currentStationData[this.stationName].flipMeta2&&([c,h]=[h,c])}else console.log("No match found",t)}this.currentStationData[this.stationName].stringPath&&(l?(c=s(l[1]?.trim())||"",h=this.applyFilters("artist",l[2]?.trim())||"","cbcmusic"!==this.stationName?(d=this.applyFilters("album",l[3]?.trim())||"",u=l[4]?.trim()||t,m=l[5]?.trim()||"",m=Number(m),m=new Date(m).getTime()):m=Number(l[3]?.trim())||"",this.currentStationData[this.stationName].flipMeta&&([c,h]=[h,c])):console.log("No match found")),h&&(h=this.cleanupArtist(h));const g=(t,e)=>{if(!t)return!1;const a=t.toLowerCase();return e.some((t=>a.includes(t.toLowerCase())))},y=t=>{const e=this.currentStationData[this.stationName].filter||[],a=this.currentStationData[this.stationName].stationName;return g(t,e)||g(t,[a])};if(!y(c)&&!y(h))return!c&&!h||c&&!h?["Station data is currently missing",null,null,this.stationArt,"","",!0]:(c=i(c),h=i(h),d=i(d),/single/i.exec(d)||d.toLowerCase().includes("single")?[c,h,c,u,m,"",!1]:(u=u||t,[c,h,d,u,m,"",!1]))}async getLfmMeta(t,e,a,i,s){try{if(!t||!e)return null;return await this.fetchLfmOrMusicBrainzData(t,e,a,i,s)}catch(t){return console.error("Error fetching Last.fm metadata:",t),null}}async fetchLfmOrMusicBrainzData(e,a,i,s,n){const r=this.constructQueryParams(e,a,i,n);if(!r||2!==r.length||!r[0]||!r[1])return console.error("üö® ERROR: constructQueryParams returned an invalid response.",r),null;const[o,l]=r;try{const[r,h]=await Promise.all([fetch(o),fetch(l)]);if(!r.ok||!h.ok)return console.error(`API request failed. LFM: ${r.status}, MB: ${h.status}`),null;const d=await r.json(),u=await h.json();let m=null,p=null;6===d.error||"track"!==n&&n?6!==d.error&&"album"==n&&(m=[d.album?.image[3]["#text"]||t,this.applyFilters("album",d.album?.name)||i||e,e||"No streaming data available",this.applyFilters("artist",d.album?.artist)||a,d.album?.listeners||null,d.album?.playcount||null]):m=[d.track.album?.image?.[3]?.["#text"]||"",d.track.album?.title||i||e,d.track.name||e,d.track.artist?.name||a,d.track.listeners||null,d.track.playcount||null,d.track.album?.artist||"",d.track?.duration||null];const g=!Array.isArray(m)||!m[0],y=Array.isArray(m)&&m[4]||null,S=Array.isArray(m)&&m[5]||null;if(u.releases?.length&&(6===d.error||g||"Various Artists"==m?.[7])){if(p=[`https://coverartarchive.org/release/${u.releases[0]?.id}/front-500`,this.applyFilters("album",u.releases[0]["release-group"]?.title)||i,this.applyFilters("track",u.releases[0]?.title)||e,u.releases[0]["artist-credit"][0]?.name||a],(p[3]!=a||p[2]!=e)&&(c=this.jaccardSimilarity(p[3],a))>=.6&&1!==c)return console.log("this.jaccardSimilarity(mbResult[3], currentArtist)",this.jaccardSimilarity(p[3],a),p[3],a),this.songMetadataChanged=!0,this.getLfmMeta(p[2],p[3],p[1],p[0],"song");if(""!==p[0]&&this.jaccardSimilarity(p[3],a)>=.9&&(!s||g))return(t=>t>=.9)(this.jaccardSimilarity(p[2],e))?[p[0],p[1],p[2],p[3],y,S]:[p[0],p[1],e,a,y,S]}let f=!s||s.includes("mzstatic.com")||s.includes("blankart.jpg")||s===t?m?.[0]||p?.[0]||t:s;return(f.includes("623304f1")||f.includes("b4df49b51c57"))&&(f=t),6!==d.error?(m[7]&&!this.duration&&(this.duration=Number(m[7]),console.log("this.duration",this.duration)),[this.upsizeImgUrl(f),m[1]||i||"",m[2]||e,m[3]||a,m[4]||null,m[5]||null]):[this.upsizeImgUrl(f),i||"",e,a,null,null]}catch(t){return console.error("Error fetching data from LFM or MB:",t),null}var c}constructQueryParams(t,e,a,i){let s,n,r="",o="",l="";return r="track.getInfo",o="track",l=t,s=`https://ws.audioscrobbler.com/2.0/?method=${r}&artist=${encodeURIComponent(this.applyFilters("artist",e))}&${o}=${encodeURIComponent(this.applyFilters(o,l))}&api_key=09498b5daf0eceeacbcdc8c6a4c01ccb&autocorrect=1&format=json&limit=1`,n=`https://musicbrainz.org/ws/2/release?fmt=json&query=title:+"${encodeURIComponent(this.applyFilters("track",t))}"^3%20${encodeURIComponent(t)}%20artistname:+"${encodeURIComponent(this.applyFilters("artist",e))}"^4${encodeURIComponent(this.applyFilters("artist",e))}%20artistname:+"-Various Artists"^4-various artists%20format:+"cd"^4cd&limit=3`,[s,n]}jaccardSimilarity(t,e){const a=new Set(t.toLowerCase().split(" ")),i=new Set(e.toLowerCase().split(" ")),s=new Set([...a].filter((t=>i.has(t)))),n=new Set([...a,...i]);return s.size/n.size}validateArtworkUrl(t){const e=/^https?:\/\//i.test(t)?t:`../${t}`;return new Promise(((t,a)=>{const i=new Image;i.src=e,i.onload=()=>{t(e)},i.onerror=()=>{t(null)}}))}checkUrlValidity(t){return fetch(t,{method:"HEAD"}).then((t=>t.ok)).catch((()=>!1))}async appendMytunerWidget(){try{const t=await fetch("mytuner.html");if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const e=await t.text(),a=document.createElement("div");a.innerHTML=e;const i=a.querySelector(".mytuner-widget");if(!i)throw new Error("Widget div not found in mytuner.html");const s=document.getElementById("mytuner-container");s?s.appendChild(i):console.error("Target element not found!"),this.executeScriptsInElement(i)}catch(t){console.error("Error appending mytuner.html:",t)}}removeMytunerWidget(){if(this.mytunerWidgetRemoved)return;[".mytuner-widget"].forEach((t=>{const e=document.querySelector(t);e&&e.remove()}));const t=["/js/widgets/player-v1.js"],e=()=>{t.forEach((t=>{document.querySelectorAll(`script[src="${t}"]`).forEach((t=>t.remove()))}))};e();const a=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(t,e){if(!e.includes("metadata-api.mytuner.mobi"))return a.apply(this,arguments);console.log("Blocked MyTuner API request:",e)};const i=window.fetch;window.fetch=function(t,e){let a="";return"string"==typeof t?a=t:t&&"object"==typeof t&&t.url&&(a=t.url),a&&a.includes("metadata-api.mytuner.mobi")?(console.log("Blocked MyTuner API fetch request:",a),Promise.reject(new Error("Blocked MyTuner API request"))):i.apply(this,arguments)};const s=new MutationObserver((t=>{t.forEach((t=>{t.addedNodes.length>0&&(e(),t.addedNodes.forEach((t=>{"SCRIPT"===t.tagName&&t.src.includes("mytuner")&&t.remove()})))}))}));s.observe(document.head,{childList:!0,subtree:!0}),s.observe(document.body,{childList:!0,subtree:!0});document.querySelectorAll("script").forEach((t=>{t.textContent.includes("mytuner")&&t.remove()})),this.mytunerWidgetRemoved=!0}executeScriptsInElement(t){t.querySelectorAll("script").forEach((t=>{const e=document.createElement("script");t.src?(e.src=t.src,e.async=!1):e.textContent=t.textContent,document.body.appendChild(e)}))}getStreamingData(){if(this.isPlaying||null==this.isPlaying){if(!this.stationName)return;if(this.lastKnownUpdatedTime-Date.now()<35e3&&this.lastKnownUpdatedTime-Date.now()>7e4&&!this.shouldReloadStream)console.log("this.lastKnownUpdatedTime is a bit too far in the future, checking again",(this.lastKnownUpdatedTime-Date.now())/1e3);else if(this.lastKnownUpdatedTime-Date.now()>2e4&&!this.shouldReloadStream)return void console.log("this.lastKnownUpdatedTime > Date.now",(this.lastKnownUpdatedTime-Date.now())/1e3);if("cbcmusic"===this.stationName?document.querySelector(".mytuner-widget")||this.appendMytunerWidget():this.removeMytunerWidget(),this.isPlaying&&!this.shouldReloadStream){let t;t=this.currentStationData[this.stationName].spinPath?`https://widgets.spinitron.com/widget/now-playing-v2?callback=_spinitron206170750999458&station=${this.currentStationData[this.stationName].spinPath}&num=0&sharing=0&player=0&cover=0&merch=0&meta=0`:this.currentStationData[this.stationName].orbPath&&!this.currentStationData[this.stationName].dataPath?`https://scraper2.onlineradiobox.com/${this.currentStationData[this.stationName].orbPath}?l=0`:this.currentStationData[this.stationName].proxyApi?`https://scrobblerad.io/proxy.php?url=${this.currentStationData[this.stationName].apiUrl}`:this.currentStationData[this.stationName].apiUrl,t=this.addCacheBuster(t);const e={method:this.currentStationData[this.stationName].method||"GET",headers:this.currentStationData[this.stationName].headers||{}};fetch(t,e).then((t=>{const e=t.headers.get("content-type");return e&&(e.includes("application/json")||e.includes("application/vnd.api+json")||this.currentStationData[this.stationName].phpString&&!this.currentStationData[this.stationName].htmlString)?t.json().then((t=>({data:t,contentType:e}))):e&&(e.includes("text/html")||this.currentStationData[this.stationName].jsonString&&e.includes("text/plain")||e.includes("application/javascript"))?t.text().then((t=>({data:t,contentType:e}))):void 0})).then((({data:t,contentType:e})=>{if(e&&e.includes("text/html")&&!this.currentStationData[this.stationName].phpString&&"cbcmusic"!==this.stationName){const e=(new DOMParser).parseFromString(t,"text/html");t=this.extractDataFromHTML(e)}else if(e&&e.includes("text/html")&&"cbcmusic"==this.stationName&&null!==window.mytuner_scripts.mytunerMeta){if(console.log("window.mytuner_scripts.mytunerMeta",window.mytuner_scripts.mytunerMeta),null===window.mytuner_scripts.mytunerMeta)return;t=window.mytuner_scripts.mytunerMeta}else if(e&&e.includes("application/javascript")){const e=this.extractHTMLFromJS(t),a=(new DOMParser).parseFromString(e,"text/html");t=this.extractDataFromHTML(a)}else if(e&&e.includes("text/plain")&&!this.currentStationData[this.stationName].phpString)t=this.extractJsonFromJS(t);else if(e&&e.includes("text/html")&&this.currentStationData[this.stationName].phpString&&!this.currentStationData[this.stationName].htmlString||this.currentStationData[this.stationName].phpString&&e.includes("text/plain"));else if(e&&e.includes("text/html")&&this.currentStationData[this.stationName].htmlString){const e=t,a=(new DOMParser).parseFromString(e,"text/html");t=this.extractDataFromHTML(a)}if(this.isDataSameAsPrevious(t))this.lastDataUpdateTime&&Date.now()-this.lastDataUpdateTime>9e5&&(console.log("Data is the same, but it's now stale"),this.previousDataResponse=t,this.processData(t));else{if(this.songMetadataChanged)return console.log("Skipping update: song metadata was altered externally."),void(this.songMetadataChanged=!1);this.previousDataResponse=t,this.processData(t),this.lastDataUpdateTime=Date.now(),this.duration=null}})).catch((t=>{console.error("Error fetching streaming data:",t)}))}}}extractHTMLFromJS(t){const e=t.match(/_spinitron\d+\("(.+)"\);/s);if(e&&e[1])return e[1].replace(/\\"/g,'"');throw new Error("Unable to extract HTML content from JavaScript response")}extractJsonFromJS(t){const e=t.match(/jsonpcallback\((.*)\);/);if(!e||!e[1])throw new Error("Unable to extract JSON content from the response");try{return JSON.parse(e[1])}catch(t){throw new Error("Failed to parse JSON from the response: "+t.message)}}extractDataFromHTML(t){const e=t=>t.replace(/‚Äî/g,"‚Äî");let a;a=this.currentStationData[this.stationName].htmlString?["div.song-details:first-child",".radio-song-title"," p:first-child"," .album-title"," .album-art"," p:last-child"]:["",".song",".artist",".release","img",".spin-time a"];return{song:e(t.querySelector(`${a[0]}${a[1]}`)?.textContent.trim()||"No streaming data currently available"),artist:e(t.querySelector(`${a[0]}${a[2]}`)?.textContent.trim()||""),album:e(t.querySelector(`${a[0]}${a[3]}`)?.textContent.trim()||""),albumArt:t.querySelector(`${a[4]}`)?.src||"",spinUpdated:t.querySelector(`${a[0]}${a[5]}`)?.textContent.trim()||""}}isDataSameAsPrevious(t){return JSON.stringify(t)===JSON.stringify(this.previousDataResponse)}updateScrobbleData(t,e,a){if(t&&e&&a){const i={trackTitle:t,trackArtist:e,trackAlbum:a,trackTimestamp:Math.floor(Date.now()/1e3)};updateNowPlaying(i),this.currentTrack===i&&this.currentTrack||(this.currentTrack&&this.currentTrack!==i&&(this.scrobbleTimeout&&(clearTimeout(this.scrobbleTimeout),this.scrobbleTimeout=null),this.songStartTime&&Date.now()-this.songStartTime>=6e4&&scrobbleIt(this.currentTrack),this.songStartTime=null),this.currentTrack=i,this.currentTrack&&!this.songStartTime&&(this.songStartTime=Date.now(),this.scrobbleTimeout=setTimeout((()=>{this.currentTrack&&scrobbleIt(this.currentTrack)}),6e4)))}}processData(e){if(e&&this.stationName){const a=this.extractSongAndArtist(e,this.stationName);if(JSON.stringify(this.prevExtractedData)===JSON.stringify(a)&&"Station data loading"!==navigator.mediaSession.metadata.title)return void console.log("extracted data the same, returning");if(this.prevExtractedData=a,!a||0===a.length){return void new s(this.stationName,this).refreshCurrentData(["[ Air break ]","","",this.stationArt,null,null,!0])}this.hasLoadedData=!0;const[i,n,r,o,l,c,h]=a,d=this.currentStationData[this.stationName].timezone;let u;"indie1023"==[this.stationName]?(u=`${this.getPath(e,this.currentStationData[this.stationName].timestamp[0])} ${this.getPath(e,this.currentStationData[this.stationName].timestamp[1])} GMT-06:00`,console.log("102.3 timestamp",u)):this.currentStationData[this.stationName].reverseArray?(u=this.getPath(e,this.getLastJsonPath(this.currentStationData[this.stationName].timestamp,e)),console.log("timestamp reverse array",u)):(u=this.getPath(e,this.currentStationData[this.stationName].timestamp),0!=u&&""!=u||(u=void 0)),!this.currentStationData[this.stationName].altPath||i&&u||("indie1023"==[this.stationName]?(u=`${this.getPath(e,this.currentStationData[this.stationName].timestamp[2])} ${this.getPath(e,this.currentStationData[this.stationName].timestamp[3])}`,console.log("102.3 timestamp",u)):(u=this.getPath(e,this.currentStationData[this.stationName].timestamp2),this.duration=this.getPath(e,this.currentStationData[this.stationName].duration2),console.log("altpath timestamp",u)));const{staleData:m}=this.checkStaleData(d,u,l,this.getPath(e,this.currentStationData[this.stationName].duration),i);if(("Live365 past"===m||"Still future"===m)&&i)return;if("indie1023"==[this.stationName]&&"Station data is currently missing"==i){return void new s(this.stationName,this).refreshCurrentData(["[ Air Break ]","","",this.stationArt,null,null,!0])}if("Station data is currently missing"==i&&!m){return void new s(this.stationName,this).refreshCurrentData([i,"","",this.stationArt,null,null,!0])}if(m||"No streaming data currently available"===i||h){return void new s(this.stationName,this).refreshCurrentData([m||i,"","",this.stationArt,null,null,!0])}this.lfmMetaChanged&&i.toLowerCase()===this.song.toLowerCase()||this.getLfmMeta(i,n,r,o,"","",!1).then((e=>{const[a,r,o,l,c,h]=e||[t,"",i,n,"",""];this.song=o,this.artist=l,this.album=r||o,this.artworkUrl=a||t,this.updateScrobbleData(this.song,this.artist,this.album),this.listeners=c||null,this.playcount=h||null,this.lfmMetaChanged=!0;new s(this.stationName,this).refreshCurrentData([this.song,this.artist,this.album,this.artworkUrl,this.listeners,this.playcount,this.errorMessage])})).catch((t=>{console.error("Error processing data:",t)})),this.duration+this.lastKnownUpdatedTime>Date.now()&&(this.lastKnownUpdatedTime=this.duration+this.lastKnownUpdatedTime)}}getTimezoneOffset(t,e){const a=t.toLocaleString("ja",{timeZone:e}).split(/[/\s:]/);a[1]--;const i=Date.UTC.apply(null,a);return(new Date(t).setMilliseconds(0)-i)/60/1e3}checkStaleData(t,e,a,i,s){let n,r="";if(!t&&!e&&!a||!e&&1==a||void 0===e&&!this.currentStationData[this.stationName].spinPath&&!t)return r;let o=(new Date).toLocaleString("en-US",{timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1,timeZoneName:"longOffset"});if(e){const a=/^\d{10}(\.\d+)?$/.test(e),i=/^\d{10,13}$/.test(e);if(a||i){const t=parseFloat(e);n=t<1e12?Math.floor(1e3*t):Math.floor(t)}else n=this.convertTimestamp(e,t)}else if(a&&"cbcmusic"==this.stationName)n=this.convertTimestamp(a,t);else if(a&&"cbcmusic"!==this.stationName){let i=this.formatTimeInTimezone(t,e,Number(a));const s=new Date;const r=new Intl.DateTimeFormat("en-US",{timeZone:t,timeZoneName:"longOffset"}).formatToParts(s);n=`${i} ${Object.fromEntries(r.map((({type:t,value:e})=>[t,e]))).timeZoneName}`,n=Date.parse(n)}else t&&!e&&(console.log("timezone and no timestamp",e),s!==this.song?(this.fallbackTimestamp=Date.parse(o),n=this.fallbackTimestamp):this.fallbackTimestamp&&(n=this.fallbackTimestamp));if(o=Date.parse(o),this.currentStationData[this.stationName].offset+n<o&&(n=this.currentStationData[this.stationName].offset+n,o=this.currentStationData[this.stationName].offset+o),i)if(this.duration=i,this.duration>0)n+=i;else{const t=(t=>"number"==typeof t&&t>=1e3&&t<1e13)(this.duration)?this.duration:this.convertDurationToMilliseconds(this.duration);i<=600?n+=1e3*i:t>0?n+=t:(n+=i,console.log("apiUpdatedData else",n)),console.log("apiUpdatedData + duration =",n)}if(this.currentStationData[this.stationName].isFuture){const t=Date.now(),e=t-24e4;if(this.lastKnownUpdatedTime||(this.lastKnownUpdatedTime=n),n<this.lastKnownUpdatedTime)return console.log("Skipping older song data ‚Äî already showing newer content.",n,this.lastKnownUpdatedTime),r="Live365 past",{staleData:r};if(n<e)return console.log("Song data is over 240 seconds old, waiting for fresh data."),r="Waiting for fresh data",{staleData:r};n<t&&console.log("Song data is slightly in the past but still recent."),n>t+2e3&&console.log("‚è© Song data appears to be in the future."),this.lastKnownUpdatedTime=n}n.length>13&&(n=Number.parseInt(n.slice(0,13))),this.lastKnownUpdatedTime=n,console.log("this.lastKnownUpdatedTime",this.lastKnownUpdatedTime);const l=(o-n)/1e3;return console.log("apiUpdatedData",n,"timezoneTime",o,"timeDifference",l),l>900&&""!==n&&(r="Streaming data is stale"),{staleData:r}}convertDurationToMilliseconds(t){const e=t.split(":"),a=parseInt(e[0],10)||0,i=parseInt(e[1],10)||0,s=e[2].split("."),n=parseInt(s[0],10)||0,r=s[1]?parseInt(s[1],10)/Math.pow(10,s[1].length)*1e3:0;return Math.round(1e3*(3600*a+60*i+n)+r)}convertTimestamp(t,e,a){const i=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?(Z|([+-]\d{2}:\d{2}))?$/,s=/^\d{10,13}$/.test(t),n="string"==typeof t&&t.trim().endsWith("Z"),r=/^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$/;if("string"==typeof t&&i.test(t))return new Date(t).getTime();if(/^(\d{2}\/\d{2}\/\d{4}|\d{4}-\d{2}-\d{2}) \d{2}:\d{2}:\d{2}$/.test(t))return t=this.formatTimeInTimezone(e,t,a),new Date(t).getTime();if(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}(?:\.\d+)?$/.test(t)){const[e,a]=t.split(" "),[i,s,n]=e.split("-");return new Date(`${`${s}/${n}/${i}`}, ${a} GMT`).getTime()}if(/^20\d{10}$/.test(t)){const e=parseInt(t.substring(0,4),10),a=parseInt(t.substring(4,6),10)-1,i=parseInt(t.substring(6,8),10),s=parseInt(t.substring(8,10),10),n=parseInt(t.substring(10,12),10);return new Date(e,a,i,s,n).getTime()}if(s){const e=Number(t);return e<1e12?1e3*e:e}if(n)return new Date(t).getTime();if("string"==typeof t&&i.test(t))return t.endsWith("+0000")&&(t=t.replace("+0000","Z")),new Date(t).getTime();if(r.test(t)||r.test(this.formattedTimestamp)){const[i,s]=t.split(" "),[n,r,o]=i.split("-"),l=`${o}-${n}-${r}T${s}`;return t=(t=this.formatTimeInTimezone(e,l,a)).replace(/([-+]\d{2})(\d{2})$/,"$1:$2"),new Date(t).getTime()}return new Date(t).getTime()}formatTimeInTimezone(t,e,a){let i="";console.log("timestamp",e,"spinUpdated",a);const s=(new Date).toLocaleString("en-US",{timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour12:!1});(new Date).toLocaleString("en-US",{timeZone:t,timeZoneName:"short"}).split(" ").pop();if(a&&!0!==a&&"cbcmusic"!==this.stationName){i=`${s} ${(t=>{const[e,a]=t.split(" ");let[i,s]=e.split(":");return"PM"===a&&"12"!==i?i=parseInt(i,10)+12:"AM"===a&&"12"===i&&(i="00"),`${i}:${s}`})(a)}`,console.log("spinUpdated apiUpdatedTime",i)}else a&&!0!==a&&"cbcmusic"==this.stationName&&(i=this.convertTimestamp(a,t),console.log("spinUpdated apiUpdatedTime",i));if(e){const a=new Date(e),s=new Intl.DateTimeFormat("en-US",{timeZone:t,hour12:!1,timeZoneName:"shortOffset"}).formatToParts(a);let n=s.find((t=>"timeZoneName"===t.type))?.value;n.startsWith("GMT")&&(n=n.replace("GMT",""));const r=n.match(/([+-])(\d+)/);if(r){n=`${r[1]}${r[2].padStart(2,"0")}${"00"}`}i=e=e.replace(" ","T").replace(/(\d{2})\/(\d{2})\/(\d{4})/,"$3-$1-$2").replace(/([-+]\d{2})(\d{2})$/,"$1:$2")+n}return i}loadHTMLContent(t,e,a){const i=document.getElementById(a);i?t?fetch(e).then((t=>{if(!t.ok)throw new Error("Network response was not ok");return t.text()})).then((t=>{i.innerHTML=t})).catch((t=>{console.error("There was a problem with the fetch operation:",t)})):i.innerHTML="":console.error(`Element with ID "${a}" not found in the DOM.`)}upsizeImgUrl(t){if(t)return t.replace(/\d{3}x\d{3}/g,"500x500")}getPath(t,e){if(!t||"object"!=typeof t||!e)return;const a=e.split(".");let i=t;for(let t=0;t<a.length;t++){if(void 0===i[a[t]])return;i=i[a[t]]}return i}play(){this.audio.src&&(this.shouldReloadStream?(console.log("the stream is reloading"),this.handleStationSelect(null,this.stationName,!1),this.shouldReloadStream=!1):this.audio.play().then((()=>{this.isPlaying=!0,this.playButton.lastElementChild.className="icon-pause",document.getElementById("metadata").classList.add("playing"),this.pauseTimeout&&(clearTimeout(this.pauseTimeout),this.pauseTimeout=null)})).catch((t=>{console.error("Error playing audio:",t)})))}pause(){this.playButton.classList.contains("spinner-grow")?this.audio.play():(this.audio.pause(),this.isPlaying=!1,this.playButton.lastElementChild.className="icon-play",document.getElementById("metadata").classList.remove("playing"),this.pauseTimeout&&clearTimeout(this.pauseTimeout),this.pauseTimeout=setTimeout((()=>{console.log("the stream should be reloaded");new s(this.stationName,this).refreshCurrentData(["Press reload to refresh feed","","",this.stationArt,null,null,!0]),document.getElementById("playermeta").classList.add("opacity-50"),this.hls&&this.destroyHLSAndResetAudio(),this.shouldReloadStream=!0}),3e4))}togglePlay(){this.page&&this.page.scrobbleTimeout&&(clearTimeout(this.page.scrobbleTimeout),console.log("Scrobble timeout cleared due to playback stop."),this.page.scrobbleTimeout=null),this.isPlaying?this.pause():this.play()}skipToNextStation(){this.calculateNextAndPreviousIndices("next");const t=this.nextStationName;this.handleStationSelect(null,t,!0)}skipBackward(){this.calculateNextAndPreviousIndices("previous");const t=this.previousStationName;this.handleStationSelect(!0,t,!0)}skipForward(){this.calculateNextAndPreviousIndices("next");const t=this.nextStationName;this.handleStationSelect(null,t,!0)}onTagSelected(t){a=t,i(t)}onAllTagsSelected(){a="all",i("all")}reloadStream(){this.shouldReloadStream=!0,console.log("reload working"),this.playButton.lastElementChild.className="spinner-grow text-light",document.getElementById("panel1"),this.calculateNextAndPreviousIndices();const t=e[this.currentIndex];this.handleStationSelect(!0,t,!0),this.scrobbleReset}scrobbleReset(){clearTimeout(this.page.scrobbleTimeout)}addCacheBuster(t){const e=Date.now();return["radiowestern","kexp","wrir","wprb","krcl","cbcmusic","indie1023","somagroovesalad"].includes(this.stationName)?t:t.includes("?")?`${t}&t=${e}`:`${t}?t=${e}`}destroy(){this.streamingInterval&&(clearInterval(this.streamingInterval),this.streamingInterval=null),this.currentPage&&(this.currentPage.destroy(),this.currentPage=null)}}(document.getElementById("playButton"),document.getElementById("skipForward"),document.getElementById("skipBack"),document.getElementById("reloadStream"));document.addEventListener("DOMContentLoaded",(async function(){await i(),n.jumpToStationFromHash();const t=e[0];n.handleStationSelect(!1,t,!0);const a=document.getElementById("stationSelect");a?a.addEventListener("change",(t=>{const e=t.target.value;n.handleStationSelect(!0,e,!0)}),{once:!0}):console.error('Element with ID "stationSelect" not found.'),window.matchMedia("(display-mode: standalone)").matches&&document.body.classList.add("fullscreen-mode");const s=document.querySelector(".mobile-swipe"),r=document.getElementById("panel2");s&&r&&s.scrollTo({left:r.offsetLeft,behavior:"smooth"})}),{once:!0})}();
//# sourceMappingURL=main-dist.js.map