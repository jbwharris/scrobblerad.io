!function(){const t="img/defaultArt.png";let e=Object.keys(stations),a="";async function i(){a=await async function(t){try{return!!(await fetch(t,{method:"GET",mode:"cors"})).ok}catch(t){return"TypeError"===t.name&&t.message.includes("Failed to fetch"),!1}}("https://api.wnyc.org/api/v1/whats_on/");const t=document.getElementById("stationSelect");t.innerHTML="";const i=document.createDocumentFragment();e=e.filter((t=>{const e=stations[t];return!1!==a||!e.cors||(delete stations[t],!1)})),e.forEach((t=>{const e=stations[t],a=document.createElement("button");a.name=t,a.textContent=e.stationName;const s=document.createElement("input");s.type="radio",s.name="station",s.value=t,s.checked=t===n.stationName;const r=document.createElement("img");r.src=`img/stations/${t}.png`,r.width="45",r.height="45",r.loading="lazy",a.appendChild(s),a.prepend(r),i.appendChild(a)})),t.appendChild(i),t.addEventListener("click",(t=>{const e=t.target.closest("button");if(e){t.preventDefault();const a=e.name;window.location.hash=`#${a}`,n.handleStationSelect(null,a,!0)}})),document.getElementById("togglePanels").addEventListener("click",(function(){const t=document.getElementById("panel1"),e=document.getElementById("panel2"),a=document.getElementById("panel3"),i=document.querySelector("#togglePanels .icon-hide-panels, #togglePanels .icon-show-panels");t.classList.toggle("show"),e.classList.toggle("grow"),a.classList.toggle("show"),i&&(i.classList.contains("icon-hide-panels")?(i.classList.remove("icon-hide-panels"),i.classList.add("icon-show-panels")):(i.classList.remove("icon-show-panels"),i.classList.add("icon-hide-panels")))}))}class s{constructor(t,e){this.stationName=t,this.displayStationName=stations[t].stationName,this.radioPlayer=e,this.cacheDOMElements(),this.template=document.querySelector("#meta")}cacheDOMElements(){const t={currentSong:"title",currentArtist:"artist",currentAlbum:"album",currentListeners:"listeners",coverArt:"albumArt",radioNameLink:"radioNameLink",radioName:"radioName",stationLocation:"stationLocation",metaInfo:"metainfo"};for(const[e,a]of Object.entries(t))this[e+"Element"]=document.getElementById(a)}formatCompactNumber(t){return t<1e3?t:t>=1e3&&t<1e6?(t/1e3).toFixed(1).replace(/\.0$/,"")+"K":t>=1e6&&t<1e9?(t/1e6).toFixed(1).replace(/\.0$/,"")+"M":t>=1e9&&t<1e12?(t/1e9).toFixed(1).replace(/\.0$/,"")+"B":void 0}refreshCurrentData(e){const[a,i,s,n,r,o,,l,c]=e;setTimeout((()=>{const e=()=>{if(!a&&!i||!n||!l[this.stationName])return;let e;e=n==t?`img/stations/${this.stationName}.png`:n;const h=document.querySelector("div.playermeta");h.textContent="";const d=document.querySelector("#meta"),m=document.importNode(d.content,!0);m.querySelector("#title").innerHTML=a,m.querySelector("#artist").textContent=i,m.querySelector("#album").textContent=s,m.querySelector("#listeners").textContent=null!==r&&null!==o?`Listeners: ${this.formatCompactNumber(r)} | Plays: ${this.formatCompactNumber(o)}`:"",m.querySelector("#albumArt").src=e||n,m.querySelector("#albumArt").alt=`${a} by ${i}`;m.querySelector("#radioNameLink").href=l[this.stationName].webUrl,m.querySelector("#radioName").textContent=l[this.stationName].stationName,m.querySelector("#stationLocation").textContent=l[this.stationName].location,h.appendChild(m),document.getElementById("playermeta").classList.remove("opacity-50");const u=n===t?`url("../${e}")`:`url("${e}")`;document.documentElement.style.setProperty("--albumArt",u),function(t,e=2e3){t.classList.add("animated","fadeIn"),setTimeout((()=>{t.classList.remove("animated","fadeIn")}),e)}(h),document.querySelector("#panel2").click(),this.setupMediaSession(a,i,n,c)},h=new Image;h.onload=()=>{setTimeout(e,0)},h.src=n}),1500)}setupMediaSession(e,a,i,s){if(e.includes("<br/>"))return;let n,r="";if(s||"currently loading"==a?r="":e&&a&&"currently loading"!==a&&(r=`Now playing on ${this.displayStationName}`),n=i==t?`img/stations/${this.stationName}.png`:i,"mediaSession"in navigator){if(navigator.mediaSession.metadata=new MediaMetadata({title:e,artist:a||"",album:r||"",duration:1/0,startTime:0,artwork:[{src:n}]}),!e&&!a||"currently loading"==a)return void(document.title="");(e&&a||!s)&&(document.title=`${e} - ${a} | ${this.displayStationName} on scrobblerad.io`);const t={nexttrack:()=>this.radioPlayer.skipForward(),previoustrack:()=>this.radioPlayer.skipBackward(),play:()=>this.radioPlayer.togglePlay(),pause:()=>this.radioPlayer.togglePlay()};for(const[e,a]of Object.entries(t))navigator.mediaSession.setActionHandler(e,a)}}}const n=new class{constructor(t,e,a,i){this.currentStationData=null,this.audio=new Audio,this.playButton=t,this.skipForwardButton=e,this.skipBackButton=a,this.reloadStreamButton=i,this.isPlaying=null,this.stationName="",this.previousDataResponse=null,this.prevExtractedData=null,this.pauseTimeout=null,this.shouldReloadStream=!1,this.stations=document.querySelectorAll(".station"),this.debounceTimeout=null,this.firstRun=!0,this.streamingInterval=null,this.canAutoplay=!1,this.errorMessage=!1,this.getLfmMeta=this.getLfmMeta.bind(this),this.songMetadataChanged=!1,this.debouncedPlayAudio=this.debounce((t=>{this.audio&&(this.audio.pause(),this.audio=null),setTimeout((()=>{this.audio=t,this.getStreamingData(),this.play(),this.isPlaying=!0}),500)}),1500),this.bindMethods(),this.addEventListeners(),this.init()}bindMethods(){this.handleStationSelect=this.handleStationSelect.bind(this),this.getLfmMeta=this.getLfmMeta.bind(this),this.getStreamingData=this.getStreamingData.bind(this),this.extractSongAndArtist=this.extractSongAndArtist.bind(this),this.getPath=this.getPath.bind(this),this.upsizeImgUrl=this.upsizeImgUrl.bind(this),this.togglePlay=this.togglePlay.bind(this),this.skipForward=this.skipForward.bind(this),this.skipBackward=this.skipBackward.bind(this),this.reloadStream=this.reloadStream.bind(this)}async addEventListeners(){this.playButton.addEventListener("click",this.togglePlay),this.skipForwardButton.addEventListener("click",this.skipForward),this.skipBackButton.addEventListener("click",this.skipBackward),this.reloadStreamButton.addEventListener("click",this.reloadStream),document.getElementById("stationSelect").addEventListener("click",(t=>{t.target&&t.target.matches("input[name='station']")&&(this.handleStationSelect(t,t.target.value,!0),t.target.scrollIntoView({behavior:"smooth",block:"nearest"}))})),this.jumpToStationFromHash(),document.addEventListener("DOMContentLoaded",(()=>{this.jumpToStationFromHash()}),{once:!0})}init(){"serviceWorker"in navigator&&navigator.serviceWorker.register("serviceWorker.js").then((t=>{console.log("Service worker registered",t),t.waiting&&console.log("Service worker is waiting to activate"),t.onupdatefound=()=>{console.log("New service worker update found!");const e=t.installing;e.onstatechange=()=>{"installed"===e.state&&(navigator.serviceWorker.controller?console.log("New service worker installed, but waiting to activate"):console.log("Service worker installed for the first time"))}}})).catch((t=>console.log("Service worker not registered",t)))}calculateNextAndPreviousIndices(t){this.currentIndex=e.indexOf(this.stationName),this.nextIndex=(this.currentIndex+1)%e.length,this.previousIndex=(this.currentIndex-1+e.length)%e.length}debounce(t,e){return(...a)=>{this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=setTimeout((()=>{t.apply(this,a)}),e)}}jumpToStationFromHash(){const t=window.location.hash;if(t){const e=t.substring(1),a=document.querySelector(`button[name='${e}']`);a&&(a.scrollIntoView({behavior:"smooth",block:"center"}),this.handleStationSelect(null,e,!0))}}async loadStationData(t){try{const e=await fetch(t),a=await e.text();return new Function(a+"; return stationData;")()}catch(t){console.error("Error loading station data:",t)}}async handleStationSelect(e,a,i){if(!a||!1===e)return;document.getElementById("playermeta").classList.add("opacity-50");const n=await this.loadStationData(`/js/stations/${a}.js`);if(!n)return;this.currentStationData=n;const r=new s(a,this);this.streamingInterval&&(clearInterval(this.streamingInterval),this.streamingInterval=null),i&&(r.setupMediaSession(this.currentStationData[a].stationName,"currently loading",t,!1),r.refreshCurrentData([`${this.currentStationData[a].stationName}<br/> currently loading`,"","",t,null,null,!0,this.currentStationData],!0),this.playButton.lastElementChild.className="spinner-grow text-light",this.lfmMetaChanged=!1,console.log(a),this.stationName=a,this.updateArt=!0,this.isPlaying=!0,this.songMetadataChanged=!1,i=!1);this.debounce((()=>{if(!this.isPlaying)return;if(!this.currentStationData[this.stationName])return void console.error("currentStationData is undefined or null");const t=new Audio(this.addCacheBuster(this.currentStationData[this.stationName].streamUrl));t.onloadedmetadata=()=>{this.lfmMetaChanged=!1,this.debouncedPlayAudio(t),this.streamingInterval=setInterval((()=>{this.getStreamingData()}),25e3)},t.onerror=t=>{console.warn("Error loading audio:",t),this.isPlaying&&(!0===e?this.skipBackward():this.skipForward())},t.load();const i=document.querySelector(`input[name='station'][value='${a}']`);i&&(i.checked=!0),window.location.hash=`#${a}`}),250)()}cleanupArtist(t){let e=t;if([/ x .*/,/ feat\..*/].forEach((t=>{e=e.replace(t,"")})),e.includes(", ")){const t=e.split(", ").map((t=>t.trim()));2===t.length?e=`${t[1]} ${t[0]}`:t.length>2&&(e=`${t.slice(-1)[0]} ${t.slice(0,-1).join(" ")}`)}return e.trim()}getFilterSet(){return{artist:[MetadataFilter.normalizeFeature],track:[MetadataFilter.removeRemastered,MetadataFilter.removeFeature,MetadataFilter.removeLive,MetadataFilter.removeCleanExplicit,MetadataFilter.removeVersion,MetadataFilter.youtube],album:[MetadataFilter.removeRemastered,MetadataFilter.removeFeature,MetadataFilter.removeLive,MetadataFilter.removeCleanExplicit,MetadataFilter.removeVersion]}}applyFilters(t,e){return["track","artist","album"].includes(t)||console.error(`Invalid filter field: ${t}`),e}getDataAtPath(t,e){const a=t.split(".");let i=e;for(let t of a){if(!i||!i.hasOwnProperty(t))return;i=i[t]}return i}getLastJsonPath(t,e){if("string"!=typeof t||!t)return console.error("Invalid path passed to getLastJsonPath:",t),t;const a=t.split(".");for(let t=0;t<a.length;t++)if(/^\d+$/.test(a[t])){const i=a.slice(0,t).join("."),s=this.getDataAtPath(i,e);Array.isArray(s)&&(a[t]=(s.length-1).toString());break}return a.join(".")}extractSongAndArtist(e,a){const i=t=>t?.replace(/&apos;|&#039;|’|‘|‚|‛|`|´/g,"'").replace(/–|—/g,"-").replace(/[“”„]/g,'"').replace(/…/g,"...").replace(/\u00A0/g," ").replace(/[\t\n\r]/g,"").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/\s*\[.*?\]/g,"").replace(/[*/|\\]/g,"").replace(/--/g,"-").trim()||"",s=t=>t?t.replace(/\s*\(.*?version.*?\)/gi,"").replace(/\s-\s.*version.*$/i,"").replace(/\s*\(.*?edit.*?\)/gi,"").replace(/\s-\s.*edit.*$/i,"").replace(/[\(\[]\d{4}\s*Mix[\)\]]/gi,"").replace(/\s*\([\d]{4}\s*Remaster(ed)?\)/gi,"").replace(/\s*-\s*[\d]{4}\s*Remaster(ed)?/gi,"").replace(/\s*\(.*?\bofficial\b.*?\)/gi,"").replace(/\s*-\s*Remaster(ed)?/gi,"").replace(/([\)\]])\s*\d{4}.*/,"$1").trim():"",n=t=>this.getPath(e,this.currentStationData[this.stationName][t]),r=this.currentStationData[this.stationName].pathRegex||/^(.*?)\s+-\s+(.*?)(?:\s+-\s+([^-\n]*))?(?:\s+-\s+(.*))?$/,o=r.exec(e);let l=s(n("song")),c=this.applyFilters("artist",n("artist")),h=this.applyFilters("album",n("album")),d=n("albumArt"),m="",u=e.title;if(this.currentStationData[a].reverseArray&&(l=s(this.getPath(e,this.getLastJsonPath(this.currentStationData[a].song,e))),c=this.applyFilters("artist",this.getPath(e,this.getLastJsonPath(this.currentStationData[a].artist,e))),h=this.applyFilters("album",this.getPath(e,this.getLastJsonPath(this.currentStationData[a].album,e))),console.log("song, artist and album reverse array",l,c,h)),this.currentStationData[this.stationName].altPath&&!l&&(l=s(n("song2")),c=this.applyFilters("artist",n("artist2")),h=this.applyFilters("album",n("album2")),d=n("albumArt2")),this.currentStationData[this.stationName].spinPath&&(l=s(e.song)||"",c=this.applyFilters("artist",e.artist)||"",h=this.applyFilters("album",e.album)||"",d=e.albumArt||"",m=e.spinUpdated||""),this.currentStationData[this.stationName].htmlPath&&(l=s(e.song)||"",c=this.applyFilters("artist",e.artist)||"",h=this.applyFilters("album",e.album)||"",d=e.albumArt||"",m=e.spinUpdated||""),this.currentStationData[this.stationName].orbPath){1==this.currentStationData[this.stationName].dataPath?u=e.data.title:this.currentStationData[this.stationName].dataPath&&(u=e[this.currentStationData[this.stationName].dataPath]);const t=r.exec(u);t?([c,l,h]=t.slice(1,4).map((t=>t?.trim())),l=s(l),c=this.applyFilters("artist",c),h=this.applyFilters("album",h),this.currentStationData[this.stationName].flipMeta&&([l,c]=[c,l])):console.log("No match found",t)}this.currentStationData[this.stationName].stringPath&&(o?(l=s(o[1]?.trim())||"",c=this.applyFilters("artist",o[2]?.trim())||"",h=this.applyFilters("album",o[3]?.trim())||"",d=o[4]?.trim()||t,m=o[5]?.trim()||"",this.currentStationData[this.stationName].flipMeta&&([l,c]=[c,l])):console.log("No match found")),this.currentStationData[this.stationName].htmlPath&&(o?(l=s(o[1]?.trim())||"",c=this.applyFilters("artist",o[2]?.trim())||"",h=this.applyFilters("album",o[3]?.trim())||"",d=o[4]?.trim()||t,m=o[5]?.trim()||"",this.currentStationData[this.stationName].flipMeta&&([l,c]=[c,l])):console.log("No match found")),c&&(c=this.cleanupArtist(c));const p=(t,e)=>{if(!t)return!1;const a=t.toLowerCase();return e.some((t=>a.includes(t.toLowerCase())))},g=t=>{const e=this.currentStationData[this.stationName].filter||[],a=this.currentStationData[this.stationName].stationName;return p(t,e)||p(t,[a])};return g(l)||g(c)?["Station data contains filtered terms",null,null,t,"","",!0]:!l&&!c||l&&!c?["Station data is currently missing",null,null,t,"","",!0]:(l=i(l),c=i(c),h=i(h),/single/i.exec(h)||h.toLowerCase().includes("single")?[l,c,l,d,m,"",!1]:(d=d||t,[l,c,h,d,m,"",!1]))}async getLfmMeta(t,e,a,i,s){try{if(!t||!e)return null;return await this.fetchLfmOrMusicBrainzData(t,e,a,i,s)}catch(t){return console.error("Error fetching Last.fm metadata:",t),null}}async fetchLfmOrMusicBrainzData(e,a,i,s,n){const r=this.constructQueryParams(e,a,i,n);if(!r||2!==r.length||!r[0]||!r[1])return console.error("🚨 ERROR: constructQueryParams returned an invalid response.",r),null;const[o,l]=r;try{const[r,c]=await Promise.all([fetch(o),fetch(l)]);if(!r.ok||!c.ok)return console.error(`API request failed. LFM: ${r.status}, MB: ${c.status}`),null;const h=await r.json(),d=await c.json();let m=null,u=null;6===h.error||"track"!==n&&n?6!==h.error&&"album"==n&&(m=[h.album?.image[3]["#text"]||t,this.applyFilters("album",h.album?.name)||i||e,e||"No streaming data available",this.applyFilters("artist",h.album?.artist)||a,h.album?.listeners||null,h.album?.playcount||null]):m=[h.track.album?.image?.[3]?.["#text"]||"",h.track.album?.title||i||e,h.track.name||e,h.track.artist?.name||a,h.track.listeners||null,h.track.playcount||null];const p=!Array.isArray(m)||!m[0],g=Array.isArray(m)&&m[4]||null,S=Array.isArray(m)&&m[5]||null;if(d.releases?.length&&(6===h.error||p)){if(u=[`https://coverartarchive.org/release/${d.releases[0]?.id}/front-500`,this.applyFilters("album",d.releases[0]["release-group"]?.title)||i,this.applyFilters("track",d.releases[0]?.title)||e,d.releases[0]["artist-credit"][0]?.name||a],(u[3]!=a||u[2]!=e)&&(this.jaccardSimilarity(u[3],a)>=.6||this.jaccardSimilarity(u[2],e)>=.6))return this.songMetadataChanged=!0,this.getLfmMeta(u[2],u[3],u[1],u[0],"song");if(""!==u[0]&&(!s||p))return[u[0],u[1],u[2],u[3],g,S]}let y=s&&s!==t?s:m[0]||(u?u[0]:t);return 6!==h.error?[y,m[1]||i||"",m[2]||e,m[3]||a,m[4]||null,m[5]||null]:[y,i||"",e,a,null,null]}catch(t){return console.error("Error fetching data from LFM or MB:",t),null}}constructQueryParams(t,e,a,i){let s,n,r="",o="",l="";return r="track.getInfo",o="track",l=t,s=`https://ws.audioscrobbler.com/2.0/?method=${r}&artist=${encodeURIComponent(this.applyFilters("artist",e))}&${o}=${encodeURIComponent(this.applyFilters(o,l))}&api_key=09498b5daf0eceeacbcdc8c6a4c01ccb&autocorrect=1&format=json&limit=1`,n=`https://musicbrainz.org/ws/2/release?fmt=json&query=title:+"${encodeURIComponent(this.applyFilters("track",t))}"^3%20${encodeURIComponent(t)}%20artistname:+"${encodeURIComponent(this.applyFilters("artist",e))}"^4${encodeURIComponent(this.applyFilters("artist",e))}&limit=3`,[s,n]}jaccardSimilarity(t,e){const a=new Set(t.toLowerCase().split(" ")),i=new Set(e.toLowerCase().split(" ")),s=new Set([...a].filter((t=>i.has(t)))),n=new Set([...a,...i]);return s.size/n.size}checkUrlValidity(t){return fetch(t,{method:"HEAD"}).then((t=>t.ok)).catch((e=>(console.error("Error fetching URL:",t,e),!1)))}getStreamingData(){if(this.isPlaying||null==this.isPlaying){if(!this.stationName)return;if("cbcmusic"==[this.stationName]){const t=document.querySelector("span.player-radio-name span:last-child")?.textContent.trim()||"";if(console.log("cbcData",t),this.isDataSameAsPrevious(t))return;this.previousDataResponse=t,this.processData(t)}if(this.isPlaying&&!this.shouldReloadStream){let t=this.addCacheBuster(this.currentStationData[this.stationName].apiUrl);const e={method:this.currentStationData[this.stationName].method||"GET",headers:this.currentStationData[this.stationName].headers||{}};fetch(t,e).then((t=>{const e=t.headers.get("content-type");if(e&&(e.includes("application/json")||e.includes("application/vnd.api+json")||this.currentStationData[this.stationName].phpString&&!this.currentStationData[this.stationName].htmlString))return t.json().then((t=>({data:t,contentType:e})));if(e&&(e.includes("text/html")||e.includes("application/javascript")))return t.text().then((t=>({data:t,contentType:e})));throw new Error(`Unsupported content type or missing content-type header: ${e}`)})).then((({data:t,contentType:e})=>{if(e&&e.includes("text/html")&&!this.currentStationData[this.stationName].phpString){const e=(new DOMParser).parseFromString(t,"text/html");t=this.extractDataFromHTML(e)}else if(e&&e.includes("application/javascript")){const e=this.extractHTMLFromJS(t),a=(new DOMParser).parseFromString(e,"text/html");t=this.extractDataFromHTML(a)}else if(e&&e.includes("text/html")&&this.currentStationData[this.stationName].phpString&&!this.currentStationData[this.stationName].htmlString);else if(e&&e.includes("text/html")&&this.currentStationData[this.stationName].htmlString){const e=t,a=(new DOMParser).parseFromString(e,"text/html");t=this.extractDataFromHTML(a)}if(this.lastDataUpdateTime=null,this.isDataSameAsPrevious(t))this.lastDataUpdateTime&&Date.now()-this.lastDataUpdateTime>9e5&&(console.log("Data is the same, but it's now stale"),this.previousDataResponse=t,this.processData(t));else{if(this.songMetadataChanged)return console.log("Skipping update: song metadata was altered externally."),void(this.songMetadataChanged=!1);console.log("Data changed, processing update."),this.previousDataResponse=t,this.processData(t),this.lastDataUpdateTime=Date.now()}})).catch((t=>{console.error("Error fetching streaming data:",t)}))}}}extractHTMLFromJS(t){const e=t.match(/_spinitron\d+\("(.+)"\);/s);if(e&&e[1])return e[1].replace(/\\"/g,'"');throw new Error("Unable to extract HTML content from JavaScript response")}extractDataFromHTML(t){const e=t=>t.replace(/—/g,"—");if(this.currentStationData[this.stationName].htmlString){return(a=t.querySelector("div.hidden-xs")?.textContent.trim()||"No streaming data currently available",a.replace(/—/g,"—")).replace(/\s+/g," ").trim()}var a;return{song:e(t.querySelector("span.song")?.textContent.trim()||"No streaming data currently available"),artist:e(t.querySelector("span.artist")?.textContent.trim()||""),album:e(t.querySelector("span.release")?.textContent.trim()||""),albumArt:t.querySelector("img")?.src||"",spinUpdated:t.querySelector("td.spin-time a")?.textContent.trim()||""}}isDataSameAsPrevious(t){return JSON.stringify(t)===JSON.stringify(this.previousDataResponse)}changeTimeZone(t,e){return"string"==typeof t?new Date(new Date(t).toLocaleString("en-US",{timeZone:e})):new Date(t.toLocaleString("en-US",{timeZone:e}))}processData(e){if(e&&this.stationName){const a=this.extractSongAndArtist(e,this.stationName);if(!a||0===a.length){return void new s(this.stationName,this).refreshCurrentData(["No streaming data to show","","",t,null,null,!0,this.currentStationData],!0)}this.hasLoadedData=!0;const[i,n,r,o,l,c,h]=a,d=this.currentStationData[this.stationName].timezone;let m;"indie1023"==[this.stationName]?(m=`${this.getPath(e,this.currentStationData[this.stationName].timestamp[0])} ${this.getPath(e,this.currentStationData[this.stationName].timestamp[1])}`,console.log("102.3 timestamp",m)):this.currentStationData[this.stationName].reverseArray?(m=this.getPath(e,this.getLastJsonPath(this.currentStationData[this.stationName].timestamp,e)),console.log("timestamp reverse array",m)):(m=this.getPath(e,this.currentStationData[this.stationName].timestamp),0!=m&&""!=m||(m=void 0)),this.currentStationData[this.stationName].altPath&&!i&&("indie1023"==[this.stationName]?(m=`${this.getPath(e,this.currentStationData[this.stationName].timestamp[2])} ${this.getPath(e,this.currentStationData[this.stationName].timestamp[3])}`,console.log("102.3 timestamp",m)):(m=this.getPath(e,this.currentStationData[this.stationName].timestamp2),console.log("altpath timestamp",m)));const{staleData:u}=this.checkStaleData(d,m,l,this.getPath(e,this.currentStationData[this.stationName].duration),i);if("Live365 past"===u&&this.song){if(i.toLowerCase()!==this.song.toLowerCase())return}else if("Station data is currently missing"==this.song&&!u)return;if(JSON.stringify(this.prevExtractedData)===JSON.stringify(a))return;if(this.prevExtractedData=a,u||"No streaming data currently available"===i||h){return void new s(this.stationName,this).refreshCurrentData([u||i,"","",t,null,null,!0,this.currentStationData,!0])}this.lfmMetaChanged&&i.toLowerCase()===this.song.toLowerCase()||this.getLfmMeta(i,n,r,o,"","",!1).then((e=>{const[a,r,l,c,h,d]=e||[t,"",i,n,"",""];this.song=l,this.artist=c,this.album=r||l;const m=a===t?o:a;this.checkUrlValidity(m).then((e=>{const a=e?m:t;this.artworkUrl=this.upsizeImgUrl(a)||t,this.listeners=h||null,this.playcount=d||null,this.lfmMetaChanged=!0;new s(this.stationName,this).refreshCurrentData([this.song,this.artist,this.album,this.artworkUrl,this.listeners,this.playcount,!0,this.currentStationData],this.errorMessage)})).catch((t=>{console.error("Error during album art validation:",t)}))})).catch((t=>{console.error("Error processing data:",t)}))}}checkStaleData(t,e,a,i,s){let n,r="";if(!t&&!e&&!a||!e&&1==a||void 0===e&&!this.currentStationData[this.stationName].spinPath&&!t)return r;let o=(new Date).toLocaleString("en-US",{timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1,timeZoneName:"short"});if(o=new Date(o).toISOString(),e?(console.log("timestamp",e),n=this.convertTimestamp(e,t)):a?n=this.formatTimeInTimezone(t,e,a):t&&!e&&(console.log("timezone and no timestamp",e),s!==this.song?(this.fallbackTimestamp=o,n=this.fallbackTimestamp):this.fallbackTimestamp&&(n=this.fallbackTimestamp)),o=Date.parse(o),n=Date.parse(n),this.currentStationData[this.stationName].isFuture){i&&(console.log("apiUpdatedData + duration",n,"+",1e3*i,"=",n+1e3*i),n+=1e3*i),this.lastKnownUpdatedTime&&n<this.lastKnownUpdatedTime&&(console.log("Skipping older song data — already showing newer content."),r="Older than current song");const t=Date.now()-12e4,e=Date.now()-24e4;n<t&&n>e?(console.log("song data is more than 120 seconds in the past"),r="Waiting for newer song data"):n<Date.now()?console.log("song data is slightly in the past but still recent"):console.log("song data is still in the future"),this.lastKnownUpdatedTime=n}this.currentStationData[this.stationName].offset+n<o&&(n=this.currentStationData[this.stationName].offset+n);const l=(o-n)/1e3;return console.log("apiUpdatedData",n,"timezoneTime",o,"timeDifference",l),l>900&&""!==n&&(r="Streaming data is stale"),{staleData:r}}convertTimestamp(t,e,a){const i=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?(Z|([+-]\d{2}:\d{2}))?$/,s=/^\d{10,13}$/.test(t),n="string"==typeof t&&t.trim().endsWith("Z");if("string"==typeof t&&i.test(t))return t.endsWith("Z")||t.endsWith("Z")||/[+-]\d{2}:\d{2}$/.test(t)||(t=this.formatTimeInTimezone(e,t,a)),new Date(t).toISOString();if(/^20\d{10}$/.test(t)){const e=parseInt(t.substring(0,4),10),a=parseInt(t.substring(4,6),10)-1,i=parseInt(t.substring(6,8),10),s=parseInt(t.substring(8,10),10),n=parseInt(t.substring(10,12),10);return t=new Date(e,a,i,s,n).toISOString()}if(s){const e=Number(t);return t=e<1e12?1e3*e:e,t=new Date(t).toISOString()}if(n)return console.log("getting to UTC?"),new Date(t).toISOString();if("string"==typeof t&&i.test(t))t.endsWith("+0000")&&(t=t.replace("+0000","Z"),t=new Date(t).toISOString());else if(/^(\d{2}\/\d{2}\/\d{4}|\d{4}-\d{2}-\d{2}) \d{2}:\d{2}:\d{2}$/.test(t))t=this.formatTimeInTimezone(e,t,a),t=new Date(t).toISOString();else if(/^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$/.test(t)){const[i,s]=t.split(" "),[n,r,o]=i.split("-"),l=`${o}-${n}-${r}T${s}`;t=(t=this.formatTimeInTimezone(e,l,a)).replace(/([-+]\d{2})(\d{2})$/,"$1:$2"),t=new Date(t).toISOString()}return t}formatTimeInTimezone(t,e,a){let i="";console.log("timestamp",e,"spinUpdated",a);const s=(new Date).toLocaleString("en-US",{timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour12:!1}),n=(new Date).toLocaleString("en-US",{timeZone:t,timeZoneName:"short"}).split(" ").pop();if(a&&!0!==a){i=`${s} ${(t=>{const[e,a]=t.split(" ");let[i,s]=e.split(":");return"PM"===a&&"12"!==i?i=parseInt(i,10)+12:"AM"===a&&"12"===i&&(i="00"),`${i}:${s}`})(a)} ${n}`}if(e){const a=new Date(e),s=new Intl.DateTimeFormat("en-US",{timeZone:t,hour12:!1,timeZoneName:"shortOffset"}).formatToParts(a);let n=s.find((t=>"timeZoneName"===t.type))?.value;n.startsWith("GMT")&&(n=n.replace("GMT",""));const r=n.match(/([+-])(\d+)/);if(r){n=`${r[1]}${r[2].padStart(2,"0")}${"00"}`}i=e=e.replace(" ","T").replace(/(\d{2})\/(\d{2})\/(\d{4})/,"$3-$1-$2").replace(/([-+]\d{2})(\d{2})$/,"$1:$2")+n}return i}upsizeImgUrl(t){if(t)return t.replace(/\d{3}x\d{3}/g,"500x500")}getPath(t,e){if(!t||"object"!=typeof t||!e)return;const a=e.split(".");let i=t;for(let t=0;t<a.length;t++){if(void 0===i[a[t]])return;i=i[a[t]]}return i}play(){this.audio.src&&(this.shouldReloadStream?(console.log("the stream is reloading"),this.handleStationSelect(null,this.stationName,!0),this.shouldReloadStream=!1):this.audio.play().then((()=>{this.isPlaying=!0,this.playButton.lastElementChild.className="icon-pause",document.getElementById("metadata").classList.add("playing"),this.pauseTimeout&&(clearTimeout(this.pauseTimeout),this.pauseTimeout=null)})).catch((t=>{console.error("Error playing audio:",t)})))}pause(){this.playButton.classList.contains("spinner-grow")?this.audio.play():(this.audio.pause(),this.isPlaying=!1,this.playButton.lastElementChild.className="icon-play",document.getElementById("metadata").classList.remove("playing"),this.pauseTimeout&&clearTimeout(this.pauseTimeout),this.pauseTimeout=setTimeout((()=>{console.log("the stream should be reloaded"),document.getElementById("playermeta").classList.add("opacity-50"),this.shouldReloadStream=!0}),3e4))}togglePlay(){this.isPlaying?this.pause():this.play()}skipToNextStation(){this.calculateNextAndPreviousIndices();const t=e[this.nextIndex];this.handleStationSelect(null,t,!0)}skipBackward(){this.playButton.lastElementChild.className="spinner-grow text-light",this.calculateNextAndPreviousIndices();const t=e[this.previousIndex];this.handleStationSelect(!0,t,!0)}skipForward(){this.playButton.lastElementChild.className="spinner-grow text-light",this.calculateNextAndPreviousIndices();const t=e[this.nextIndex];this.handleStationSelect(null,t,!0)}reloadStream(){this.shouldReloadStream=!0,console.log("reload working"),this.playButton.lastElementChild.className="spinner-grow text-light",document.getElementById("panel1"),this.calculateNextAndPreviousIndices();const t=e[this.currentIndex];this.handleStationSelect(!0,t,!0)}addCacheBuster(t){const e=(new Date).getTime();return"radiowestern"===this.stationName?t:t.includes("?")?`${t}&t=${e}`:`${t}?t=${e}`}}(document.getElementById("playButton"),document.getElementById("skipForward"),document.getElementById("skipBack"),document.getElementById("reloadStream"));document.addEventListener("DOMContentLoaded",(async function(){await i(),n.jumpToStationFromHash();const t=e[0];n.handleStationSelect(!1,t,!0);const a=document.getElementById("stationSelect");a?a.addEventListener("change",(t=>{const e=t.target.value;n.handleStationSelect(!0,e,!0)}),{once:!0}):console.error('Element with ID "stationSelect" not found.');const s=document.querySelector(".mobile-swipe"),r=document.getElementById("panel2");s&&r&&s.scrollTo({left:r.offsetLeft,behavior:"smooth"})}),{once:!0})}();
//# sourceMappingURL=main-dist.js.map