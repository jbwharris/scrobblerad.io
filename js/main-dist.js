const urlCoverArt="img/defaultArt.png",stationKeys=Object.keys(stations);let skipCORS="";async function generateRadioButtons(){const t=await isCORSEnabled("https://api.wnyc.org/api/v1/whats_on/"),e=document.getElementById("stationSelect");e.innerHTML="";const a=document.createDocumentFragment();Object.keys(stations).forEach((e=>{const a=stations[e];!1===t&&a.cors&&delete stations[e]}));Object.keys(stations).forEach((t=>{const e=stations[t],i=document.createElement("button");i.name=t,i.textContent=e.stationName;const n=document.createElement("input");n.type="radio",n.name="station",n.value=t,n.checked=t===radioPlayer.stationName,i.appendChild(n),a.appendChild(i)})),e.appendChild(a),e.addEventListener("click",(t=>{const e=t.target.closest("button");if(e){t.preventDefault();const a=e.name;window.location.hash=`#${a}`,radioPlayer.handleStationSelect(null,a,!0)}})),document.getElementById("togglePanels").addEventListener("click",(function(){const t=document.getElementById("panel1"),e=document.getElementById("panel2"),a=document.getElementById("panel3"),i=document.querySelector("#togglePanels .icon-hide-panels, #togglePanels .icon-show-panels");t.classList.toggle("show"),e.classList.toggle("grow"),a.classList.toggle("show"),i&&(i.classList.contains("icon-hide-panels")?(i.classList.remove("icon-hide-panels"),i.classList.add("icon-show-panels")):(i.classList.remove("icon-show-panels"),i.classList.add("icon-hide-panels")))}))}async function isCORSEnabled(t){try{return!!(await fetch(t,{method:"GET",mode:"cors"})).ok}catch(t){return"TypeError"===t.name&&t.message.includes("Failed to fetch"),!1}}function animateElement(t,e=2e3){t.classList.add("animated","fadeIn"),setTimeout((()=>{t.classList.remove("animated","fadeIn")}),e)}class Page{constructor(t,e){this.stationName=t,this.displayStationName=stations[t].stationName,this.radioPlayer=e,this.cacheDOMElements(),this.setupMediaSession("","",""),this.template=document.querySelector("#meta")}cacheDOMElements(){const t={currentSong:"title",currentArtist:"artist",currentAlbum:"album",currentListeners:"listeners",coverArt:"albumArt",radioNameLink:"radioNameLink",radioName:"radioName",stationLocation:"stationLocation",metaInfo:"metainfo"};for(const[e,a]of Object.entries(t))this[e+"Element"]=document.getElementById(a)}formatCompactNumber(t){return t<1e3?t:t>=1e3&&t<1e6?(t/1e3).toFixed(1).replace(/\.0$/,"")+"K":t>=1e6&&t<1e9?(t/1e6).toFixed(1).replace(/\.0$/,"")+"M":t>=1e9&&t<1e12?(t/1e9).toFixed(1).replace(/\.0$/,"")+"B":void 0}refreshCurrentData(t){const[e,a,i,n,s,r,,o]=t;setTimeout((()=>{const t=()=>{if(!e&&!a||!n||!o[this.stationName])return;const t=document.querySelector("div.playermeta");t.textContent="";const l=document.querySelector("#meta"),c=document.importNode(l.content,!0);c.querySelector("#title").textContent=e,c.querySelector("#artist").textContent=a,c.querySelector("#album").textContent=i,c.querySelector("#listeners").textContent=null!==s&&null!==r?`Listeners: ${this.formatCompactNumber(s)} | Plays: ${this.formatCompactNumber(r)}`:"",c.querySelector("#albumArt").src=n,c.querySelector("#albumArt").alt=`${e} by ${a}`;c.querySelector("#radioNameLink").href=o[this.stationName].webUrl,c.querySelector("#radioName").textContent=o[this.stationName].stationName,c.querySelector("#stationLocation").textContent=o[this.stationName].location,t.appendChild(c);const h=n===urlCoverArt?`url("../${n}")`:`url("${n}")`;document.documentElement.style.setProperty("--albumArt",h),animateElement(t),document.querySelector("#panel2").click(),this.setupMediaSession(e,a,n)},l=new Image;l.onload=()=>{setTimeout(t,0)},l.src=n}),1500)}setupMediaSession(t,e,a){if("mediaSession"in navigator){navigator.mediaSession.metadata=new MediaMetadata({title:t,artist:e||"",album:`Now playing on ${this.displayStationName}`||"",duration:1/0,startTime:0,artwork:[{src:a}]}),t&&e?document.title=`${t} - ${e} | ${this.displayStationName} on scrobblerad.io`:t&&!e&&(document.title=`${t} | ${this.displayStationName} on scrobblerad.io`);const i={nexttrack:()=>this.radioPlayer.skipForward(),previoustrack:()=>this.radioPlayer.skipBackward(),play:()=>this.radioPlayer.togglePlay(),pause:()=>this.radioPlayer.togglePlay()};for(const[t,e]of Object.entries(i))navigator.mediaSession.setActionHandler(t,e)}}}class RadioPlayer{constructor(t,e,a,i){this.currentStationData=null,this.audio=new Audio,this.playButton=t,this.skipForwardButton=e,this.skipBackButton=a,this.reloadStreamButton=i,this.isPlaying=null,this.stationName="",this.previousDataResponse=null,this.pauseTimeout=null,this.shouldReloadStream=!1,this.stations=document.querySelectorAll(".station"),this.debounceTimeout=null,this.firstRun=!0,this.streamingInterval=null,this.canAutoplay=!1,this.debouncedPlayAudio=this.debounce((t=>{this.audio&&(this.audio.pause(),this.audio=null),setTimeout((()=>{this.audio=t,this.getStreamingData(),this.play(),this.isPlaying=!0}),500)}),1500),this.bindMethods(),this.addEventListeners(),this.init()}bindMethods(){this.handleStationSelect=this.handleStationSelect.bind(this),this.getLfmMeta=this.getLfmMeta.bind(this),this.getStreamingData=this.getStreamingData.bind(this),this.extractSongAndArtist=this.extractSongAndArtist.bind(this),this.getPath=this.getPath.bind(this),this.upsizeImgUrl=this.upsizeImgUrl.bind(this),this.togglePlay=this.togglePlay.bind(this),this.skipForward=this.skipForward.bind(this),this.skipBackward=this.skipBackward.bind(this),this.reloadStream=this.reloadStream.bind(this)}async addEventListeners(){this.playButton.addEventListener("click",this.togglePlay),this.skipForwardButton.addEventListener("click",this.skipForward),this.skipBackButton.addEventListener("click",this.skipBackward),this.reloadStreamButton.addEventListener("click",this.reloadStream),document.getElementById("stationSelect").addEventListener("click",(t=>{t.target&&t.target.matches("input[name='station']")&&(this.handleStationSelect(t,t.target.value,!0),t.target.scrollIntoView({behavior:"smooth",block:"nearest"}))})),this.jumpToStationFromHash(),document.addEventListener("DOMContentLoaded",(()=>{this.jumpToStationFromHash()}),{once:!0})}init(){"serviceWorker"in navigator&&navigator.serviceWorker.register("serviceWorker.js").then((t=>{console.log("Service worker registered",t),t.waiting&&console.log("Service worker is waiting to activate"),t.onupdatefound=()=>{console.log("New service worker update found!");const e=t.installing;e.onstatechange=()=>{"installed"===e.state&&(navigator.serviceWorker.controller?console.log("New service worker installed, but waiting to activate"):console.log("Service worker installed for the first time"))}}})).catch((t=>console.log("Service worker not registered",t)))}calculateNextAndPreviousIndices(t){this.currentIndex=stationKeys.indexOf(this.stationName),this.nextIndex=(this.currentIndex+1)%stationKeys.length,this.previousIndex=(this.currentIndex-1+stationKeys.length)%stationKeys.length}debounce(t,e){return(...a)=>{this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=setTimeout((()=>{t.apply(this,a)}),e)}}jumpToStationFromHash(){const t=window.location.hash;if(t){const e=t.substring(1),a=document.querySelector(`button[name='${e}']`);a&&(a.scrollIntoView({behavior:"smooth",block:"center"}),this.handleStationSelect(null,e,!0))}}async loadStationData(t){try{const e=await fetch(t),a=await e.text();return new Function(a+"; return stationData;")()}catch(t){console.error("Error loading station data:",t)}}async handleStationSelect(t,e,a){if(!e||!1===t)return;const i=await this.loadStationData(`/js/stations/${e}.js`);if(!i)return;this.currentStationData=i,this.streamingInterval&&(clearInterval(this.streamingInterval),this.streamingInterval=null),a&&(this.playButton.lastElementChild.className="spinner-grow text-light",this.lfmMetaChanged=!1,console.log(e),this.stationName=e,this.updateArt=!0,this.isPlaying=!0,a=!1);this.debounce((()=>{if(!this.isPlaying)return;if(!this.currentStationData[this.stationName])return void console.error("currentStationData is undefined or null");this.currentStationData[this.stationName].stationName;const a=new Audio(this.addCacheBuster(this.currentStationData[this.stationName].streamUrl));a.onloadedmetadata=()=>{this.lfmMetaChanged=!1,this.debouncedPlayAudio(a),this.streamingInterval=setInterval((()=>{this.getStreamingData()}),25e3)},a.onerror=e=>{console.warn("Error loading audio:",e),this.isPlaying&&(!0===t?this.skipBackward():this.skipForward())},a.load();const i=new Page(this.stationName,this);document.title=`${this.currentStationData[e].stationName} currently loading`,i.setupMediaSession(`${this.currentStationData[e].stationName} currently loading`,"",urlCoverArt);const n=document.querySelector(`input[name='station'][value='${e}']`);n&&(n.checked=!0),window.location.hash=`#${e}`}),250)()}cleanupArtist(t){let e=t;return[/ x .*/,/ feat\..*/].forEach((t=>{e=e.replace(t,"")})),e.trim()}getFilterSet(){return{artist:[MetadataFilter.normalizeFeature],track:[MetadataFilter.removeRemastered,MetadataFilter.removeFeature,MetadataFilter.removeLive,MetadataFilter.removeCleanExplicit,MetadataFilter.removeVersion,MetadataFilter.youtube],album:[MetadataFilter.removeRemastered,MetadataFilter.removeFeature,MetadataFilter.removeLive,MetadataFilter.removeCleanExplicit,MetadataFilter.removeVersion]}}applyFilters(t,e){return MetadataFilter.createFilter(this.getFilterSet()).filterField(t,e)}extractSongAndArtist(t,e){const a=t=>t?.replace(/&apos;|&#039;|’|‘|‚|‛|`|´/g,"'").replace(/–|—/g,"-").replace(/[“”„]/g,'"').replace(/…/g,"...").replace(/\u00A0/g," ").replace(/[\t\n\r]/g,"").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/\s*\[.*?\]/g,"").replace(/[*/|\\]/g,"").replace(/--/g,"-").trim()||"",i=e=>this.getPath(t,this.currentStationData[this.stationName][e]);let n=i("song"),s=i("artist"),r=i("album"),o=i("albumArt"),l="",c=t.title;if(this.currentStationData[this.stationName].altPath&&!n&&(n=i("song2"),s=i("artist2"),r=i("album2"),o=i("albumArt")),this.currentStationData[this.stationName].spinPath&&(n=t.song||"",s=t.artist||"",r=t.album||"",o=t.albumArt||"",l=t.updated||""),this.currentStationData[this.stationName].orbPath){this.currentStationData[this.stationName].dataPath&&(c=t.data.title);const e=(this.currentStationData[this.stationName].pathRegex||/^(.*?)\s+-\s+(.*?)(?:\s+-\s+([^-\n]*))?(?:\s+-\s+(.*))?$/).exec(c);e?([s,n,r]=e.slice(1,4).map((t=>t?.trim())),this.currentStationData[this.stationName].flipMeta&&([n,s]=[s,n])):console.log("No match found")}if(this.currentStationData[this.stationName].stringPath){const e=(this.currentStationData[this.stationName].pathRegex||/^(.*?)\s+-\s+(.*?)(?:\s+-\s+([^-\n]*))?(?:\s+-\s+(.*))?$/).exec(t);e?(n=e[1]?.trim()||"",s=e[2]?.trim()||"",r=e[3]?.trim()||"",o=e[4]?.trim()||urlCoverArt,l=e[5]?.trim()||"",console.log("match[5]?.trim()",e[5]?.trim()),this.currentStationData[this.stationName].flipMeta&&([n,s]=[s,n])):console.log("No match found")}s&&(s=this.cleanupArtist(s)),n&&(n=this.applyFilters("track",n).replace(/\s*\(.*?version.*?\)/gi,"").replace(/\s-\s.*version.*$/i,"").replace(/\s*\(.*?edit.*?\)/gi,"").replace(/\s-\s.*edit.*$/i,"").replace(/[\(\[]\d{4}\s*Mix[\)\]]/i,"").replace(/\s*-\s*\d{4}\s*Remastered.*/i,"").trim(),s=this.applyFilters("artist",s),r=this.applyFilters("album",r));const h=(t,e)=>{if(!t)return!1;const a=t.toLowerCase();return e.some((t=>a.includes(t.toLowerCase())))},d=t=>{const e=this.currentStationData[this.stationName].filter||[],a=this.currentStationData[this.stationName].stationName;return h(t,e)||h(t,[a])};return d(n)||d(s)?["Station may be taking a break",null,null,urlCoverArt]:n||s?(n=a(n),s=a(s),r=a(r),/single/i.exec(r)?[n,s,n,o,l]:(o=o||urlCoverArt,[n,s,r,o,l])):["Station data is currently missing",null,null,urlCoverArt]}getLfmMeta(t,e,a){return new Promise(((i,n)=>{if(""!==t&&""!==e){let s="",r="",o="";a?(s="album.getInfo",r="album",o=a):(s="track.getInfo",r="track",o=t);const l=`https://ws.audioscrobbler.com/2.0/?method=${s}&artist=${encodeURIComponent(this.applyFilters("artist",e))}&${r}=${encodeURIComponent(this.applyFilters(r,o))}&api_key=09498b5daf0eceeacbcdc8c6a4c01ccb&autocorrect=1&format=json&limit=1`;fetch(l).then((t=>t.json())).then((r=>{let o="",l="",c="",h="",d=null,u=null;if(6!==r.error)a?(o=r.album?.image[3]["#text"]||urlCoverArt,l=this.applyFilters("album",r.album?.name)||a||"",c=t||"No streaming data currently available",h=this.applyFilters("artist",r.album?.artist)||e||"",d=r.album.listeners||null,u=r.album.playcount||null):(o=r.track?.album?.image[3]["#text"]||urlCoverArt,l=this.applyFilters("album",r.track?.album?.title)||a||"",c=this.applyFilters("track",r.track?.name)||t||"No streaming data currently available",h=this.applyFilters("artist",r.track?.artist?.name)||e||"",d=r.track.listeners||null,u=r.track.playcount||null);else{if("album.getInfo"===s)return void this.getLfmMeta(t,e,"").then(i).catch(n);o=urlCoverArt,l=this.applyFilters("album",a)||"",c=this.applyFilters("track",t)||"No streaming data currently available",h=this.applyFilters("track",e)||"",d=null,u=null}i([o,l,c,h,d,u])})).catch((t=>{console.error("Error fetching Last.fm metadata:",t),n(t)}))}else i(null)}))}getStreamingData(){if(this.isPlaying||null==this.isPlaying){if(!this.stationName)return;if(this.isPlaying&&!this.shouldReloadStream){let t=this.addCacheBuster(this.currentStationData[this.stationName].apiUrl);const e={method:this.currentStationData[this.stationName].method||"GET",headers:this.currentStationData[this.stationName].headers||{}};fetch(t,e).then((t=>{const e=t.headers.get("content-type");if(e.includes("application/json")||e.includes("application/vnd.api+json"))return t.json().then((t=>({data:t,contentType:e})));if(e.includes("text/html")||e.includes("application/javascript"))return t.text().then((t=>({data:t,contentType:e})));throw new Error(`Unsupported content type: ${e}`)})).then((({data:t,contentType:e})=>{if(e.includes("text/html")&&!this.currentStationData[this.stationName].phpString){const e=(new DOMParser).parseFromString(t,"text/html");t=this.extractDataFromHTML(e)}else if(e.includes("application/javascript")){const e=this.extractHTMLFromJS(t),a=(new DOMParser).parseFromString(e,"text/html");t=this.extractDataFromHTML(a)}else e.includes("text/html")&&this.currentStationData[this.stationName].phpString&&console.log("data",t);this.isDataSameAsPrevious(t)||(this.previousDataResponse=t,this.processData(t))})).catch((t=>{console.error("Error fetching streaming data:",t)}))}}}extractHTMLFromJS(t){const e=t.match(/_spinitron\d+\("(.+)"\);/s);if(e&&e[1])return e[1].replace(/\\"/g,'"');throw new Error("Unable to extract HTML content from JavaScript response")}extractDataFromHTML(t){const e=t=>t.replace(/-/g,"—"),a=e(t.querySelector("span.song")?.textContent.trim()||"No streaming data currently available"),i=e(t.querySelector("span.artist")?.textContent.trim()||""),n=e(t.querySelector("span.release")?.textContent.trim()||""),s=t.querySelector("img")?.src||"",r=t.querySelector("td.spin-time a")?.textContent.trim()||"";return console.log("updated",r),{song:a,artist:i,album:n,albumArt:s,updated:r}}isDataSameAsPrevious(t){return JSON.stringify(t)===JSON.stringify(this.previousDataResponse)}changeTimeZone(t,e){return"string"==typeof t?new Date(new Date(t).toLocaleString("en-US",{timeZone:e})):new Date(t.toLocaleString("en-US",{timeZone:e}))}processData(t){if(t&&this.stationName){const e=this.extractSongAndArtist(t,this.stationName);if(!e||0===e.length){return void new Page(this.stationName,this).refreshCurrentData(["No streaming data to show","","",urlCoverArt,null,null,!0,this.currentStationData])}this.hasLoadedData=!0;const[a,i,n,s,r]=e,o=this.currentStationData[this.stationName].timezone;let l=this.getPath(t,this.currentStationData[this.stationName].timestamp);this.currentStationData[this.stationName].altPath&&!a&&(l=this.getPath(t,this.currentStationData[this.stationName].timestamp2));const{staleData:c}=this.checkStaleData(o,l,r);if("No streaming data currently available"===a||c){return void new Page(this.stationName,this).refreshCurrentData([c||a,"","",urlCoverArt,null,null,!0,this.currentStationData])}this.lfmMetaChanged&&a.toLowerCase()===this.song.toLowerCase()||this.getLfmMeta(a,i,n).then((t=>{const[e,n,r,o,l,c]=t||[urlCoverArt,"",a,i,"",""];this.song=r,this.artist=o,this.album=n,this.artworkUrl=e===urlCoverArt?this.upsizeImgUrl(s)||urlCoverArt:this.upsizeImgUrl(e),this.listeners=l,this.playcount=c,this.lfmMetaChanged=!0;new Page(this.stationName,this).refreshCurrentData([this.song,this.artist,this.album,this.artworkUrl,this.listeners,this.playcount,!0,this.currentStationData])})).catch((t=>{console.error("Error processing data:",t)}))}}checkStaleData(t,e,a){let i,n="",s=(new Date).toLocaleString("en-US",{timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1,timeZoneName:"short"});s=new Date(s).toISOString(),e&&(e=this.convertTimestamp(e,t));const{apiUpdatedTime:r}=this.formatTimeInTimezone(t,e,a);i=new Date(r).toISOString(),s=Date.parse(s),i=Date.parse(i);const o=s-i;return console.log("apiUpdatedData",i,"timezoneTime",s,"timeDifference",o),o>9e5&&""!==r&&(n="Streaming data is stale"),{staleData:n}}convertTimestamp(t,e){const a=/^\d+(\.\d+)?$/.test(t),i="string"==typeof t&&t.endsWith("Z");if("string"==typeof t&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?(Z|([+-]\d{2}:\d{2}))?$/.test(t))i&&(t=new Date(t).toISOString());else if(a)t<1e12&&(t*=1e3),t=new Date(t).toISOString();else if(/^\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}:\d{2}$/.test(t)){const a=new Date(t).toLocaleString("en-US",{timeZone:e,timeZoneName:"short"}).split(" ").pop();t=new Date(`${t} ${a}`).toISOString()}return t}formatTimeInTimezone(t,e,a){let i="";const n=(new Date).toLocaleString("en-US",{timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour12:!1}),s=(new Date).toLocaleString("en-US",{timeZone:t,timeZoneName:"short"}).split(" ").pop();if(a){i=`${n} ${(t=>{const[e,a]=t.split(" ");let[i,n]=e.split(":");return"PM"===a&&"12"!==i?i=parseInt(i,10)+12:"AM"===a&&"12"===i&&(i="00"),`${i}:${n}`})(a)} ${s}`}if(e){i=`${new Date(e).toLocaleString("en-US",{timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})} ${s}`}return{apiUpdatedTime:i}}upsizeImgUrl(t){return t?t.replace(/170x170|360x360|300x300/g,"500x500"):void 0}getPath(t,e){if(!t||"object"!=typeof t||!e)return;const a=e.split(".");let i=t;for(let t=0;t<a.length;t++){if(void 0===i[a[t]])return;i=i[a[t]]}return i}play(){this.audio.src&&(this.shouldReloadStream?(console.log("the stream is reloading"),this.handleStationSelect(null,this.stationName,!0),this.shouldReloadStream=!1):this.audio.play().then((()=>{this.isPlaying=!0,this.playButton.lastElementChild.className="icon-pause",document.getElementById("metadata").classList.add("playing"),this.pauseTimeout&&(clearTimeout(this.pauseTimeout),this.pauseTimeout=null)})).catch((t=>{console.error("Error playing audio:",t)})))}pause(){this.audio.pause(),this.isPlaying=!1,this.playButton.lastElementChild.className="icon-play",document.getElementById("metadata").classList.remove("playing"),this.pauseTimeout&&clearTimeout(this.pauseTimeout),this.pauseTimeout=setTimeout((()=>{console.log("the stream should be reloaded"),this.shouldReloadStream=!0}),3e4)}togglePlay(){this.isPlaying?this.pause():this.play()}skipToNextStation(){this.calculateNextAndPreviousIndices();const t=stationKeys[this.nextIndex];this.handleStationSelect(null,t,!0)}skipBackward(){this.playButton.lastElementChild.className="spinner-grow text-light",this.calculateNextAndPreviousIndices();const t=stationKeys[this.previousIndex];this.handleStationSelect(!0,t,!0)}skipForward(){this.playButton.lastElementChild.className="spinner-grow text-light",this.calculateNextAndPreviousIndices();const t=stationKeys[this.nextIndex];this.handleStationSelect(null,t,!0)}reloadStream(){this.shouldReloadStream=!0,console.log("reload working"),this.playButton.lastElementChild.className="spinner-grow text-light",this.calculateNextAndPreviousIndices();const t=stationKeys[this.currentIndex];this.handleStationSelect(!0,t,!0)}addCacheBuster(t){const e=(new Date).getTime();return"radiowestern"===this.stationName?t:t.includes("?")?`${t}&t=${e}`:`${t}?t=${e}`}}const radioPlayer=new RadioPlayer(document.getElementById("playButton"),document.getElementById("skipForward"),document.getElementById("skipBack"),document.getElementById("reloadStream"));document.addEventListener("DOMContentLoaded",(async function(){await generateRadioButtons(),radioPlayer.jumpToStationFromHash();const t=stationKeys[0];radioPlayer.handleStationSelect(!1,t,!0);const e=document.getElementById("stationSelect");e?e.addEventListener("change",(t=>{const e=t.target.value;radioPlayer.handleStationSelect(!0,e,!0)}),{once:!0}):console.error('Element with ID "stationSelect" not found.');const a=document.querySelector(".mobile-swipe"),i=document.getElementById("panel2");a&&i&&a.scrollTo({left:i.offsetLeft,behavior:"smooth"})}),{once:!0});